<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
<style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #202020;
      color: #f5f5f5;
    }
    /* =========================
      â˜… ç”»é¢æ¨ªå¹…åˆ¶å¾¡ï¼ˆè¶…é‡è¦ï¼‰
    ========================= */
    #game-wrapper {
      position: relative;
      max-width: 1100px;   /* â† åŠç”»é¢ã§ã¡ã‚‡ã†ã©ã„ã„æ­£ä½“ */
      width: 100%;
      margin: 0 auto;      /* ä¸­å¤®å¯„ã› */
    }

    /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã®ä½™ç™½èƒŒæ™¯ */
    body {
      background: #202020;
    }

    button { padding: 5px 12px; cursor:pointer; }
    button:disabled { background:#666; cursor:default; }

    .log-container { display: flex; gap: 12px; margin-top: 10px;}
    .log-box { 
      flex: 1;
      background:#111;
      border-radius:6px;
      padding:6px;

      height:160px;          /* â˜… ç¸¦å¹…ã‚’ç¸®å° */
      overflow-y: auto;

      font-size: 11px;       /* â˜… å°‘ã—å°ã•ã */
      line-height: 1.35;     /* â˜… èª­ã¿ã‚„ã™ã•ç¶­æŒ */
      font-family: Consolas;
    }
    
    /* =========================
      â˜… é–‹ç™ºè€…å°‚ç”¨ãƒ­ã‚°åˆ¶å¾¡
    ========================= */
    .log-container,
    h3 + .log-container {
      display: none;
    }

    /* DEBUG_MODE ç”¨ */
    body.debug .log-container {
      display: flex;
    }

    .battle-log{ color:#ffd54f;}
    .skill-log{ color:#81d4fa;}
    .system-log{ color:#a5d6a7;}
    .error-log{ color:#ef9a9a;}
    .debug-log{ color:#b0bec5;}

    #skillPopup{
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center;
      z-index:10000; /* â˜… è¿½åŠ ï¼šæœ€å‰é¢ã¸ */
    }
    #skillBox{
      position: relative; /* â˜… è¿½åŠ ï¼šz-indexæœ‰åŠ¹åŒ– */
      z-index:10001;      /* â˜… è¿½åŠ ï¼šèƒŒæ™¯ã‚ˆã‚Šå‰ */
      background:#2b2b2b; padding:20px; border-radius:10px;
      width:380px;
    }

    .skillRow{ margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid #555;}
    .skillName{ color:#81d4fa; font-size:16px; }
    .skillDesc{ white-space:pre-line; font-size:13px; color:#ddd; }

    /* â˜… ã‚¹ã‚­ãƒ«ä½¿ç”¨æ¸ˆã¿ï¼ˆå›æ•°0ï¼‰ã®ãƒœã‚¿ãƒ³ */
    .skillRow button.used-up{
      background:#333 !important;
      color:#bbb !important;
      border:1px solid #555 !important;
      opacity:0.75;
      cursor:not-allowed;
    }

    /* ============================
       â˜… å…±é€šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆã‚·ãƒ§ãƒƒãƒ—ç”¨ï¼‰
    ============================ */
    .popup{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    .popup-inner{
      background:#2b2b2b;
      padding:20px;
      border-radius:10px;
      width:380px;
      max-height:80vh;
      display:flex;
      flex-direction:column;
    }
    #shopList{
      overflow-y:auto;
      flex:1;
      margin-bottom:12px;
    }



   
    /* ===== ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¨ä½“ ===== */
    .status-area {
      margin-top: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 12px;
    }

    /* ===== è‡ªåˆ† / ç›¸æ‰‹ å…±é€š ===== */
    .status-simple {
      width: 240px;
      padding: 10px;
      background: #222;
      border: 1px solid #555;
      color: #fff;
      font-size: 13px;
    }

    /* ===== ç›¸æ‰‹å´ã¯å°‘ã—è‰²ã‚’å¤‰ãˆã‚‹ ===== */
    #enemy-status-simple {
      background: #1a1a1a;
      border-color: #666;
    }
    

#phase0 {
  text-align: center;
  position: relative;
  min-height: 560px;
}

#titleModePanel {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 260px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

#titleModePanel button {
  width: 200px;
}

#phase0 .subtitle {
  font-size: 1.00em;
  letter-spacing: 0.25em;
  opacity: 0.8;
  margin-top: -20px; 
  margin-bottom: 30px;
}

/* ================= è·æ¥­ã‚«ãƒ¼ãƒ‰é…ç½® ================= */

#jobSelectArea {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
  margin: 12px 0;
}

/* ================= Title Ranking Panel ================= */
#titleRankingPanel {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 280px;
  background: #111;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 12px;
  text-align: left;
}
#titleRankingHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
#titleRankingHeader .name {
  font-size: 12px;
  opacity: 0.85;
}
#titleRankingHeader .job {
  font-size: 14px;
  font-weight: 700;
}
#titleRankingJobs {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin: 8px 0 10px 0;
}
#titleRankingJobs button {
  font-size: 11px;
  padding: 4px 8px;
}
#titleRankingList {
  font-size: 12px;
  line-height: 1.6;
}
.title-rank-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}
.title-rank-row .left {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.title-rank-row .right {
  white-space: nowrap;
  opacity: 0.9;
}

/* ================= è·æ¥­ã‚«ãƒ¼ãƒ‰UI ================= */

.job-card {
  border-radius: 10px;
  padding: 12px 14px;
  background: #444;
  cursor: pointer;

  display: flex;
  flex-direction: column;
  justify-content: space-between;

  min-height: 160px;
}
.job-header {
  font-size: 16px;
}

.job-stats {
  font-size: 13px;
}

.job-card.selected {
  outline: 3px solid #ffd54f;
}


.job-detail-btn {
  font-size: 12px;
  padding: 4px 8px;
}

/* ================= è·æ¥­ç‰¹æ€§ãƒãƒ¼ ================= */

.job-bars {
  margin: 6px 0 8px 0;
  font-size: 11px;
}

.job-bar-row {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.job-bar-label {
  width: 52px;
  opacity: 0.8;
}

.job-bar-bg {
  flex: 1;
  height: 6px;
  background: #333;
  border-radius: 4px;
  overflow: hidden;
}

.job-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #81d4fa, #4fc3f7);
  border-radius: 4px;
}

.job-rank-progress {
  font-size: 11px;
  opacity: 0.75;
  margin: 0 6px;
  white-space: nowrap;
}

#phase1 {
  position: relative;
  z-index: 1;
}

#jobDetailPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;

  z-index: 9999; /* â˜… ã“ã“ã‚’å¼·ãã™ã‚‹ */
}

/* ===============================
   æˆ¦é—˜æ¼”å‡ºã‚¨ãƒªã‚¢
================================ */


@keyframes playerAttack {
  50% { transform: translateX(20px); }
}

@keyframes enemyAttack {
  50% { transform: translateX(-20px); }
}

/* ===== ãƒ€ãƒ¡ãƒ¼ã‚¸æ•°è¡¨ç¤º ===== */
.damage-popup {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 22px;
  font-weight: bold;
  color: #ff6b6b;
  pointer-events: none;
  opacity: 0;
  animation: damageFloat 0.7s ease-out forwards;
}

/* â˜… è¿½åŠ ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸ç¨®åˆ¥ã”ã¨ã®è‰² */
.damage-popup.kind-dot {
  color: #b388ff; /* DOT */
}

.damage-popup.kind-pursuit {
  color: #ffd166; /* è¿½æ’ƒ */
}


@keyframes damageFloat {
  0% {
    opacity: 0;
    transform: translate(-50%, 10px);
  }
  20% {
    opacity: 1;
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -30px);
  }
}

/* ===== å›å¾©æ•°è¡¨ç¤º ===== */
.heal-popup {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 22px;
  font-weight: bold;
  color: #6bff95;
  pointer-events: none;
  opacity: 0;
  animation: healFloat 0.7s ease-out forwards;
}

@keyframes healFloat {
  0% {
    opacity: 0;
    transform: translate(-50%, 10px);
  }
  20% {
    opacity: 1;
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -30px);
  }
}
/* ============================
   ç°¡æ˜“ãƒãƒˆãƒ«æ¼”å‡ºï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸/ç®±/æ•°å­—ï¼‰
============================ */
#battleStage{
  position: relative; /* â˜… ãƒ©ã‚¦ãƒ³ãƒ‰/ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºç”¨ */ 
  display: flex;
  justify-content: space-between;
  align-items: center;

  max-width: 1000px;   /* â˜… è¿½åŠ  */
  margin-left: auto;  /* â˜… è¿½åŠ  */
  margin-right: auto; /* â˜… è¿½åŠ  */
  gap: 16px;

  margin: 10px auto 16px auto;/* â˜… ä¸‹ä½™ç™½ã‚’å°‘ã—å¢—ã‚„ã™ */
  padding: 18px 16px;     /* â˜… ç¸¦ã‚’åºƒã’ã‚‹ */

  min-height: 220px;      /* â˜… ç¸¦æ‹¡å¼µã®æœ¬ä½“ */

  background: #151515;
  border-radius: 10px;
  border: 1px solid #333;
}

/* ============================
   â˜… ãƒ©ã‚¦ãƒ³ãƒ‰ / ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
============================ */
#roundTurnInfo{
  position:absolute;
  top:6px;
  left:50%;
  transform:translateX(-50%);
  text-align:center;
  font-size:13px;
  line-height:1.2;
  padding:6px 10px;
  background:rgba(0,0,0,0.35);
  border:1px solid #333;
  border-radius:8px;
  pointer-events:none;
}
#roundTurnInfo #roundLabel{
  font-weight:700;
}
#roundTurnInfo #turnLabel{
  opacity:0.9;
  margin-top:2px;
}

/* =========================
   â˜… éãƒ‡ãƒãƒƒã‚°æ™‚ï¼šãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ç¸¦æ‹¡å¼µ
========================= */

/* é€šå¸¸ãƒ—ãƒ¬ã‚¤ï¼ˆãƒ­ã‚°éè¡¨ç¤ºï¼‰ */
body:not(.debug) #battleStage {
  min-height: 360px;   /* â† å¥½ã¿ã§ 320ã€œ420 èª¿æ•´OK */
  padding-top: 28px;
  padding-bottom: 28px;
}

/* ãƒ‡ãƒãƒƒã‚°æ™‚ï¼ˆãƒ­ã‚°è¡¨ç¤ºï¼‰ */
body.debug #battleStage {
  min-height: 220px;   /* â† ä»Šã¾ã§é€šã‚Š */
}

.status-area,
.log-container {
  max-width: 1100px;
  margin-left: auto;
  margin-right: auto;
}

/* â˜… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é ˜åŸŸã‚’æœ€å‰é¢ã¸ï¼ˆäººå½¢UIã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯¾ç­–ï¼‰ */
.status-area{ position:relative; z-index:20; }

/* ===== HPãƒãƒ¼ ===== */
.hp-bar {
  position: absolute;
  top: 6px;
  left: 8px;
  right: 8px;
  height: 10px;
  background: #111;
  border-radius: 6px;
  border: 1px solid #333;
  overflow: hidden;
}

/* ===== äººå½¢å°‚ç”¨ ===== */
.sprite.doll {
  width: 110px;
  height: 100px;
  background: #262026;
  border: 1px solid #664466;

  overflow: visible; /* â˜… äººå½¢ã®å¤–ã«ã¯ã¿å‡ºã™UIã‚’è¡¨ç¤ºã•ã›ã‚‹ */
}


/* äººå½¢ã®è€ä¹…ãƒãƒ¼è‰² */
.hp-fill.doll {
  background: linear-gradient(90deg, #ce93d8, #f3e5f5);
}

/* äººå½¢ãƒãƒ¼ã¯å°‘ã—ä¸‹ã’ã‚‹ */
.doll-bar {
  top: 8px;
}

/* =========================
   â˜… è£…å‚™è¡¨ç¤ºï¼ˆã‚­ãƒ£ãƒ©ä¸‹ï¼‰
========================= */

.equip-area {
  margin-top: 6px;
  display: flex;
  justify-content: center;
}

.equip-area.enemy {
  justify-content: center;
}

.equip-slot {
  width: 48px;
  height: 48px;
  border: 1px solid #666;
  border-radius: 6px;
  background: #1c1c1c;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 11px;
  color: #aaa;

  cursor: default;

  position: relative; /* â˜… ã“ã‚Œã‚’è¿½åŠ  */
}


/* æœªè£…å‚™çŠ¶æ…‹ */
.equip-slot.empty {
  opacity: 0.6;
  border-style: dashed;
}

/* å°†æ¥ï¼šè£…å‚™ä¸­ */
.equip-slot.filled {
  opacity: 1;
  border-color: #ffd54f;
  color: #ffd54f;
}

/* =========================
   â˜… è£…å‚™ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
========================= */
.equip-slot .equip-tooltip {
  display: none;
  position: absolute;
  bottom: 56px;
  left: 50%;
  transform: translateX(-50%);

  background: #111;
  border: 1px solid #666;
  border-radius: 6px;
  padding: 6px 8px;

  font-size: 11px;
  line-height: 1.4;
  white-space: pre-line;
  z-index: 100;
  width: max-content;
  max-width: 200px;
}

.equip-slot:hover .equip-tooltip {
  display: block;
}


.equip-slot.tooltip-open .equip-tooltip {
  display: block;
}
/* =========================
   â˜… ç‰¹æ®Šè£…å‚™ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆé€šå¸¸è£…å‚™ã¨åŒç­‰ï¼‰
========================= */
.special-equip-slot {
  position: relative;
}

.special-equip-slot .equip-tooltip {
  display: none;
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);

  background: #111;
  border: 1px solid #666;
  border-radius: 6px;
  padding: 6px 8px;

  font-size: 11px;
  line-height: 1.4;
  white-space: pre-line;
  z-index: 100;
  width: max-content;
  max-width: 220px;
}

.special-equip-slot:hover .equip-tooltip {
  display: block;
}


.special-equip-slot.tooltip-open .equip-tooltip {
  display: block;
}
/* =========================
   â˜… ç‰¹æ®Šè£…å‚™ã‚¨ãƒªã‚¢
========================= */

.special-equip-area {
  margin-top: 4px;
  display: flex;
  gap: 4px;
  justify-content: center;
}

.special-equip-area.enemy {
  justify-content: center;
}

.special-equip-slot {
  width: 32px;
  height: 32px;
  border: 1px solid #555;
  border-radius: 4px;
  background: #1a1a1a;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 10px;
  color: #aaa;
}

/* ç©ºæ  */
.special-equip-slot.empty {
  opacity: 0.5;
  border-style: dashed;
}

/* è£…å‚™ã‚ã‚Š */
.special-equip-slot.filled {
  border-color: #4fc3f7;
  color: #4fc3f7;
}

/* ãƒ­ãƒƒã‚¯æ  */
.special-equip-slot.locked {
  opacity: 0.25;
}

/* äººå½¢ä¸‹ã®ç‰¹æ®Šè£…å‚™ */
.special-equip-area.doll {
  margin-top: 110px; /* â˜… äººå½¢ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ä¸‹ã’ã‚‹ */
  justify-content: center;
}

/* =========================
   â˜… ç‰¹æ®Šè£…å‚™ãƒ›ãƒãƒ¼æ¼”å‡º
========================= */

.special-equip-slot {
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}

.special-equip-slot:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 8px rgba(120, 200, 255, 0.6);
}

/* è£…å‚™ã‚ã‚Šã¯å°‘ã—å¼·ã‚ */
.special-equip-slot.filled:hover {
  box-shadow: 0 0 10px rgba(255, 215, 100, 0.8);
}

/* ãƒ­ãƒƒã‚¯æ ã¯åå¿œã—ãªã„ */
.special-equip-slot.locked:hover {
  transform: none;
  box-shadow: none;
}

/* =========================
   â˜… ç‰¹æ®Šè£…å‚™ ç‚¹ç¯çŠ¶æ…‹
========================= */

.special-equip-slot.active {
  box-shadow:
    0 0 6px rgba(120, 200, 255, 0.8),
    0 0 12px rgba(120, 200, 255, 0.4);
  border-color: #7ecbff;
}

/* è£…å‚™ã‚ã‚Šï¼‹ãƒ›ãƒãƒ¼æ™‚ã¯å¼·èª¿ */
.special-equip-slot.active:hover {
  box-shadow:
    0 0 10px rgba(255, 215, 100, 0.9),
    0 0 16px rgba(255, 215, 100, 0.6);
}

.hp-fill {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #4caf50, #81c784);
  transition: width 0.25s ease;
}

.hp-fill.enemy {
  background: linear-gradient(90deg, #e53935, #ef9a9a);
}

.sprite{
  position:relative;
  width:160px;
  height:160px;
  border-radius:12px;
  background:#2a2a2a;
  border:1px solid #444;
  overflow:hidden;
}

.sprite.player{ --attackX: 22px; }
.sprite.enemy { --attackX:-22px; }

.sprite-label-row{
  position:absolute;
  left:8px;
  bottom:8px;
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
  max-width:144px;
}

.sprite-label{
  position:static;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(0,0,0,0.45);
  border:1px solid rgba(255,255,255,0.12);
}

/* =========================
   â˜… ãƒãƒ•è¡¨ç¤ºï¼ˆã‚­ãƒ£ãƒ©ç®±ç”¨ï¼‰
========================= */
.buff-strip{
  display:flex;
  align-items:center;
  gap:4px;
  flex-wrap:wrap;
}

.buff-strip-sprite{ /* spriteç”¨ï¼šã‚µã‚¤ã‚ºã‚’å°ã•ã‚ã« */
  max-width:144px;
}

.buff-slot{
  width:26px;
  height:26px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,0.18);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  position:relative;
}

.buff-slot.atk_up{ background:rgba(30,136,229,0.95); }
.buff-slot.def_up{ background:rgba(79,195,247,0.95); }
.buff-slot.atk_down{ background:rgba(120,120,120,0.9); }
.buff-slot.def_down{ background:rgba(120,120,120,0.9); }
.buff-slot.freeze{ background:rgba(90,180,255,0.85); }
.buff-slot.other{ background:rgba(60,120,200,0.65); }

.buff-slot .buff-tooltip{
  display:none;
  position:absolute;
  bottom:32px;
  left:50%;
  transform:translateX(-50%);

  background:#111;
  border:1px solid #666;
  border-radius:6px;
  padding:6px 8px;

  font-size:11px;
  line-height:1.4;
  white-space:pre-line;
  z-index:200;
  width:max-content;
  max-width:240px;
}

.buff-slot:hover .buff-tooltip{ display:block; }

.buff-slot.tooltip-open .buff-tooltip{ display:block; }

@keyframes attackMove{
  0%   { transform: translateX(0); }
  50%  { transform: translateX(var(--attackX)); }
  100% { transform: translateX(0); }
}

@keyframes hitShake{
  0%   { transform: translateX(0); filter:brightness(1); }
  30%  { transform: translateX(-4px); filter:brightness(1.25); }
  60%  { transform: translateX(4px);  filter:brightness(1.25); }
  100% { transform: translateX(0); filter:brightness(1); }
}

@keyframes healGlow{
  0%   { filter:brightness(1); }
  40%  { filter:brightness(1.35); }
  100% { filter:brightness(1); }
}

.sprite.attack{ animation: attackMove 0.26s ease-in-out; }
.sprite.hit   { animation: hitShake 0.26s ease-in-out; }
.sprite.heal  { animation: healGlow 0.45s ease-in-out; }

@keyframes floatUp{
  0%   { opacity:1; transform: translate(-50%, -50%) translateY(0); }
  100% { opacity:0; transform: translate(-50%, -50%) translateY(-34px); }
}

.damage-popup,
.heal-popup{
  position:absolute;
  left:50%;
  top:40%;
  font-weight:800;
  font-size:22px;
  pointer-events:none;
  text-shadow: 0 2px 6px rgba(0,0,0,0.65);
  animation: floatUp 0.85s ease-out forwards;
  white-space:nowrap;
}

.damage-popup{ color:#ffb3b3; }
.heal-popup  { color:#b7ffb7; }

/* ç¨®é¡åˆ¥ï¼ˆdot / pursuitï¼‰ */
.damage-popup.kind-dot{ color:#c7b3ff; }
.damage-popup.kind-pursuit{ color:#ffd28a; }


/* å·¦å³ãã‚Œãã‚Œã®é™£å–¶ */
.side {
  display: flex;
  align-items: flex-end;
  gap: 12px;
}


/* å·¦é™£å–¶ã¯å·¦å¯„ã› */
.side-self {
  justify-content: flex-start;
}

/* å³é™£å–¶ã¯å³å¯„ã› */
.side-enemy {
  justify-content: flex-end;
}

/* ã‚­ãƒ£ãƒ©ï¼‹è£…å‚™ã‚’ç¸¦ã«ã¾ã¨ã‚ã‚‹ */
.main-unit {
  display: flex;
  flex-direction: column;
  align-items: center;

  justify-content: flex-start; /* â˜… è£…å‚™åˆ†ã§ä¸‹ã«å¼•ã£å¼µã‚‰ã‚Œãªã„ */
}

/* äººå½¢ã®åº•ã‚’ã‚­ãƒ£ãƒ©ç®±ã®åº•ã«åˆã‚ã›ã‚‹ */
.side .sprite.doll {
  margin-bottom: 52px; /* â˜… è£…å‚™æ ã®é«˜ã•åˆ† */
}

/* =========================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‹è¡Œå‹•ï¼šæ¨ª3ã‚«ãƒ©ãƒ 
========================= */
.status-area{
  display: flex;
  gap: 12px;
  align-items: stretch;
}

/* å·¦å³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
.status-simple{
  flex: 1;
  min-width: 240px;
}

/* =========================
   è¡Œå‹•ã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®ãƒ»ç¸¦ä¸€åˆ—ï¼‰
========================= */
#action-area{
  display: flex;
  flex-direction: column;
  gap: 6px;

  justify-content: center;
  align-items: stretch;

  width: 120px;
  flex: 0 0 120px;

  padding: 8px 6px;
  background: #1b1b1b;
  border: 1px solid #444;
  border-radius: 8px;
}

#action-area button{
  width: 100%;
  padding: 6px 0;
  font-size: 12px;
}

  


/* ================================
   Cyber Theme Overrides
   - æ—¢å­˜UIã‚’å£Šã•ãšä¸Šæ›¸ã
================================= */
:root{
  --cy-bg0:#0b0f1a;
  --cy-bg1:#050816;
  --cy-panel:rgba(17,24,39,0.78);
  --cy-panel2:rgba(15,23,42,0.72);
  --cy-line:rgba(34,211,238,0.40);
  --cy-line2:rgba(167,139,250,0.34);
  --cy-cyan:#22d3ee;
  --cy-purple:#a78bfa;
  --cy-text:#e5e7eb;
  --cy-muted:#9ca3af;
  --cy-danger:#ff4d6d;
  --cy-ok:#22d3ee;
}

body{
  color:var(--cy-text) !important;
  background:
    radial-gradient(1200px 520px at 18% -10%, rgba(34,211,238,0.16), transparent 62%),
    radial-gradient(900px 520px at 84% 0%, rgba(167,139,250,0.14), transparent 58%),
    repeating-linear-gradient(180deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 4px),
    linear-gradient(180deg, var(--cy-bg1), var(--cy-bg0));
  background-attachment: fixed;
}

/* ãƒ‘ãƒãƒ«/ç®± */
#titlePanel, #titleRankingPanel, #phase1, #phase2, #cpuOptionArea{
  background: var(--cy-panel) !important;
  border: 1px solid rgba(34,211,238,0.22) !important;
  box-shadow: 0 0 14px rgba(34,211,238,0.08), 0 0 28px rgba(167,139,250,0.05) !important;
  backdrop-filter: blur(6px);
}

/* ã‚¿ã‚¤ãƒˆãƒ«å³ï¼šè‡ªåˆ†æˆç¸¾ */
.title-my-stats{
  margin-top:6px;
  font-size:12px;
  line-height:1.45;
  color: var(--cy-text);
  opacity:0.92;
}
.cyber-accent{ color: var(--cy-cyan); text-shadow: 0 0 8px rgba(34,211,238,0.35); font-weight: 800; }
.cyber-muted{ color: var(--cy-muted); }

/* ãƒœã‚¿ãƒ³ï¼ˆå…¨ä½“ï¼‰ */
button{
  background: rgba(15,23,42,0.92) !important;
  color: var(--cy-text) !important;
  border: 1px solid rgba(34,211,238,0.34) !important;
  border-radius: 10px !important;
  transition: box-shadow .15s ease, transform .08s ease, border-color .15s ease, background .15s ease;
}
button:hover:not(:disabled){
  border-color: rgba(34,211,238,0.65) !important;
  box-shadow: 0 0 12px rgba(34,211,238,0.22), inset 0 0 10px rgba(34,211,238,0.10) !important;
  transform: translateY(-1px);
}
button:active:not(:disabled){
  transform: translateY(0px);
  box-shadow: 0 0 10px rgba(34,211,238,0.18), inset 0 0 14px rgba(34,211,238,0.12) !important;
}
button:disabled{
  opacity: 0.45 !important;
  cursor: not-allowed !important;
  box-shadow: none !important;
}

/* å…¥åŠ› */
input, select{
  background: rgba(2,6,23,0.75) !important;
  color: var(--cy-text) !important;
  border: 1px solid rgba(34,211,238,0.24) !important;
  border-radius: 10px !important;
  outline: none;
}
input:focus, select:focus{
  border-color: rgba(34,211,238,0.60) !important;
  box-shadow: 0 0 0 3px rgba(34,211,238,0.14) !important;
}

/* ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸æ  */
#battleStage{
  background: var(--cy-panel2) !important;
  border: 1px solid rgba(34,211,238,0.20) !important;
  box-shadow: inset 0 0 22px rgba(34,211,238,0.06) !important;
}

/* ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ  */
.status-simple{
  background: rgba(2,6,23,0.55) !important;
  border: 1px solid rgba(34,211,238,0.18) !important;
  box-shadow: 0 0 12px rgba(34,211,238,0.06) !important;
}

/* ãƒ­ã‚°ç®± */
.log-box{
  background: rgba(2,6,23,0.55) !important;
  border: 1px solid rgba(34,211,238,0.15) !important;
}

/* HPãƒãƒ¼ç™ºå…‰ */
.hp-fill{
  box-shadow: 0 0 10px rgba(34,211,238,0.18);
}
.hp-fill.doll{
  box-shadow: 0 0 10px rgba(167,139,250,0.18);
}

/* ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤º */
.damage-popup{
  text-shadow: 0 0 10px rgba(255,77,109,0.30), 0 0 18px rgba(255,77,109,0.18);
}

/* å‹æ•—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆinline style ã‚’ä¸Šæ›¸ãï¼‰ */
#resultOverlay{
  background: rgba(0,0,0,0.82) !important;
}
#resultPanel{
  background: rgba(2,6,23,0.88) !important;
  border: 1px solid rgba(34,211,238,0.28) !important;
  box-shadow: 0 0 18px rgba(34,211,238,0.12), 0 0 40px rgba(167,139,250,0.08) !important;
}
#resultTitle{
  color: var(--cy-cyan) !important;
  text-shadow: 0 0 14px rgba(34,211,238,0.35) !important;
  letter-spacing: 0.22em !important;
}

/* äººå½¢ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼šãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆhover/tapï¼‰ã‚’ä½¿ã†ãŸã‚ pointer-events ã¯ç„¡åŠ¹åŒ–ã—ãªã„ */
/* =========================
   â˜… ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–
   - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢
   - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¹…ã‚’ç”»é¢ã«åã‚ã‚‹
========================= */
@media (max-width: 768px) {
  body { padding: 8px; }
  #game-wrapper { max-width: 100%; }

  #battleStage {
    flex-direction: column;
    gap: 10px;
    min-height: 0;
    padding: 10px;
  }
  .side {
    width: 100%;
    max-width: 520px;
  }

  .status-area {
    flex-direction: column;
    gap: 10px;
  }
  .status-simple {
    width: 100%;
  }

  /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é¡ã¯ç”»é¢å¹…ã«åˆã‚ã›ã‚‹ */
  #skillBox, #itemBox, #shopBox, #statusDetailBox {
    width: min(92vw, 420px);
  }

  /* ãƒœã‚¿ãƒ³ã®ã‚¿ãƒƒãƒ—æ€§ã‚’å°‘ã—ä¸Šã’ã‚‹ */
  button { padding: 10px 14px; }
}



/* =========================================================
   Neon Refresh (readability + brighter neon gradients)
   - æ—¢å­˜UIã‚’å£Šã•ãšã€Œæœ«å°¾ã€ã§ä¸Šæ›¸ã
   ========================================================= */

:root{
  --neo-bg0:#05060a;
  --neo-bg1:#0b1020;

  --neo-panel:rgba(12,16,28,.72);
  --neo-panel2:rgba(8,10,18,.82);
  --neo-border:rgba(255,255,255,.10);

  --neo-text:rgba(255,255,255,.92);
  --neo-muted:rgba(255,255,255,.66);

  --neo-cyan:#00e5ff;
  --neo-pink:#ff2bd6;
  --neo-lime:#7cff00;
  --neo-amber:#ffcc00;
  --neo-red:#ff3b3b;
  --neo-violet:#a78bfa;

  --neo-grad-accent:linear-gradient(135deg,var(--neo-cyan),var(--neo-pink));
  --neo-grad-success:linear-gradient(135deg,var(--neo-lime),var(--neo-cyan));
  --neo-grad-danger:linear-gradient(135deg,var(--neo-red),var(--neo-pink));
  --neo-grad-warm:linear-gradient(135deg,var(--neo-amber),var(--neo-pink));
  --neo-grad-violet:linear-gradient(135deg,var(--neo-violet),var(--neo-cyan));

  --neo-r-lg:16px;
  --neo-r-md:12px;

  --neo-shadow:0 14px 42px rgba(0,0,0,.55);
  --neo-glow:0 0 0 1px rgba(255,255,255,.08),0 0 26px rgba(0,229,255,.18);
}

/* èƒŒæ™¯ã‚’æ˜ã‚‹ã‚ãƒã‚ªãƒ³ã« */
body{
  color:var(--neo-text) !important;
  background:
    radial-gradient(900px 600px at 14% 10%, rgba(0,229,255,.16), transparent 60%),
    radial-gradient(900px 600px at 86% 14%, rgba(255,43,214,.14), transparent 60%),
    radial-gradient(900px 600px at 50% 92%, rgba(124,255,0,.08), transparent 60%),
    linear-gradient(180deg,var(--neo-bg1),var(--neo-bg0)) !important;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0, rgba(255,255,255,.03) 1px, transparent 1px, transparent 52px),
    repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0, rgba(255,255,255,.02) 1px, transparent 1px, transparent 52px);
  opacity:.16;
  mix-blend-mode:overlay;
}

/* ä½™ç™½ãƒ»æœ€å¤§å¹…ã‚’å°‘ã—æ‹¡å¼µ */
#game-wrapper{
  max-width:1240px !important;
  width:100%;
  margin:0 auto;
}

/* ===== ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼šå·¦å³å›ºå®š(absolute)ã‚’è§£é™¤ã—ã¦èª­ã¿ã‚„ã™ã„2ã‚«ãƒ©ãƒ ã« ===== */
#phase0{
  text-align:center;
  min-height:560px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  align-items:start;
}

#phase0 > h1,
#phase0 > .subtitle{
  grid-column:1 / -1;
}

#titleModePanel{
  position:static !important;
  transform:none !important;
  width:auto !important;
  margin:0 !important;

  padding:14px !important;
  border-radius:var(--neo-r-lg) !important;
  background:var(--neo-panel) !important;
  border:1px solid var(--neo-border) !important;
  box-shadow:var(--neo-shadow), var(--neo-glow) !important;
  backdrop-filter:blur(8px);
}

#titleRankingPanel{
  position:static !important;
  transform:none !important;
  width:auto !important;

  border-radius:var(--neo-r-lg) !important;
  background:var(--neo-panel) !important;
  border:1px solid var(--neo-border) !important;
  box-shadow:var(--neo-shadow) !important;
  backdrop-filter:blur(8px);
}

#titleRankingPanel::before,
#titleModePanel::before{
  content:"";
  display:block;
  height:6px;
  border-radius:999px;
  background:var(--neo-grad-accent);
  opacity:.95;
  margin-bottom:10px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã‚„ã™ã */
#titleModePanel button{
  width: 100% !important;
  max-width: 340px;
}

/* ===== ãƒ•ã‚§ãƒ¼ã‚º1ï¼šæº–å‚™ç”»é¢ã‚’ã‚«ãƒ¼ãƒ‰åŒ– ===== */
#phase1{
  max-width: 920px;
  margin: 0 auto;
}

#phase1 > h2{
  margin-bottom: 10px;
}

#jobSelectArea{
  margin-top: 10px;
}

/* ===== å…±é€šï¼šã‚«ãƒ¼ãƒ‰é¢¨ãƒ‘ãƒãƒ« ===== */
.status-simple,
.log-box,
#action-area,
#battleStage{
  border-radius:var(--neo-r-lg) !important;
}

/* ===== ãƒœã‚¿ãƒ³çµ±ä¸€ï¼šãƒã‚ªãƒ³ãƒ»ã‚°ãƒ©ãƒ‡ãƒ»ãƒ›ãƒãƒ¼ç™ºå…‰ ===== */
button{
  appearance:none;
  border:1px solid rgba(255,255,255,.14) !important;
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)) !important;
  color:var(--neo-text) !important;
  border-radius:12px !important;
  padding:10px 12px !important;
  cursor:pointer;
  transition:transform .08s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
  box-shadow:0 10px 26px rgba(0,0,0,.38);
}

button:hover{
  border-color:rgba(0,229,255,.36) !important;
  box-shadow:0 12px 30px rgba(0,0,0,.46), 0 0 0 1px rgba(0,229,255,.18), 0 0 18px rgba(0,229,255,.22) !important;
  filter:brightness(1.08);
}

button:active{
  transform:translateY(1px) scale(.99);
  filter:brightness(0.98);
}

button:disabled{
  opacity:.55 !important;
  filter:saturate(.65) !important;
  box-shadow:none !important;
}

/* è¡Œå‹•ãƒœã‚¿ãƒ³ï¼šå½¹å‰²ã”ã¨ã«è‰²åˆ†ã‘ï¼ˆæ—¢å­˜IDã§å¯¾å¿œï¼‰ */
#atkBtn{ background:var(--neo-grad-danger) !important; border-color:rgba(255,255,255,.18) !important; }
#skillBtn{ background:var(--neo-grad-accent) !important; border-color:rgba(255,255,255,.18) !important; }
#lvupBtn{ background:var(--neo-grad-success) !important; border-color:rgba(255,255,255,.18) !important; }
#itemBtn{ background:linear-gradient(135deg, var(--neo-cyan), rgba(255,255,255,.10)) !important; border-color:rgba(255,255,255,.18) !important; }
#shopBtn{ background:var(--neo-grad-warm) !important; border-color:rgba(255,255,255,.18) !important; }

/* è¡Œå‹•ã‚¨ãƒªã‚¢ï¼šä¸­å¤®ã®â€œæ“ä½œãƒ‡ãƒƒã‚­â€æ„Ÿã‚’å‡ºã™ */
#action-area{
  background:
    radial-gradient(220px 160px at 50% 0%, rgba(0,229,255,.18), transparent 70%),
    rgba(10,12,22,.62) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  box-shadow:var(--neo-shadow), 0 0 22px rgba(0,229,255,.10) !important;
  padding:10px 8px !important;
  gap:8px !important;
}

/* ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šä¸­å¤®ã‚’ä¸»å½¹ã«ã€æ ã¨å…‰ */
#battleStage{
  background:
    radial-gradient(760px 280px at 50% 0%, rgba(0,229,255,.18), transparent 65%),
    radial-gradient(760px 280px at 50% 100%, rgba(255,43,214,.14), transparent 65%),
    rgba(10,12,22,.55) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  box-shadow:var(--neo-shadow), var(--neo-glow) !important;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šå¯èª­æ€§ã®ãŸã‚è¡Œé–“ã¨ä½™ç™½ */
.status-simple{
  background:rgba(6,10,20,.58) !important;
  border:1px solid rgba(255,255,255,.12) !important;
  box-shadow:0 0 18px rgba(0,229,255,.07) !important;
  padding:10px 12px !important;
  font-size:13.5px !important;
  line-height:1.5 !important;
}

/* ãƒ­ã‚° */
.log-box{
  background:rgba(6,10,20,.55) !important;
  border:1px solid rgba(255,255,255,.10) !important;
}

/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼šæš—å¹•ï¼‹ã‚¬ãƒ©ã‚¹ã‚«ãƒ¼ãƒ‰ */
.popup,
#itemPopup,
#skillPopup{
  background:rgba(0,0,0,.65) !important;
  backdrop-filter:blur(4px);
}

.popup-inner,
#itemBox,
#skillBox,
#statusDetailBox{
  background:var(--neo-panel) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  border-radius:var(--neo-r-lg) !important;
  box-shadow:0 20px 60px rgba(0,0,0,.65), 0 0 22px rgba(0,229,255,.16) !important;
  overflow:hidden;
}

.popup-inner::before,
#itemBox::before,
#skillBox::before,
#statusDetailBox::before{
  content:"";
  display:block;
  height:6px;
  background:var(--neo-grad-accent);
  opacity:.95;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆChromiumï¼‰ */
*::-webkit-scrollbar{ width:10px; height:10px; }
*::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg, rgba(0,229,255,.32), rgba(255,43,214,.28));
  border:2px solid rgba(0,0,0,.35);
  border-radius:999px;
}
*::-webkit-scrollbar-track{
  background:rgba(255,255,255,.04);
  border-radius:999px;
}

/* ãƒ¢ãƒã‚¤ãƒ«ï¼šã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¯1ã‚«ãƒ©ãƒ ã« */
@media (max-width: 900px){
  #phase0{
    grid-template-columns: 1fr;
  }
}

</style>
</head>
<body>
<div id="game-wrapper">
<!-- ================= ãƒ•ã‚§ãƒ¼ã‚º0ï¼šãƒ¢ãƒ¼ãƒ‰é¸æŠ ================= -->
<div id="phase0">
<h1>Guild System</h1>
<div class="subtitle">ã‚®ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ </div>
<div id="titleModePanel">
<button id="btnRandom">ãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦</button>
<button id="btnRoom">ãƒ«ãƒ¼ãƒ å¯¾æˆ¦</button>
<button id="btnCPU">CPUæˆ¦</button>
<button disabled="">ãƒ¬ã‚¤ãƒ‰æˆ¦ï¼ˆæœªå®Ÿè£…ï¼‰</button>
</div>
<!-- ================= Title Ranking (Job Ratings) ================= -->
<div id="titleRankingPanel">
<div id="titleRankingHeader">
<div>
<div class="job" id="titleRankingJobLabel">æˆ¦å£« ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
<div class="name" id="titleAccountName">åå‰ï¼š-</div>
<div class="title-my-stats" id="titleMyStats">ã‚ãªãŸã®æˆç¸¾ï¼š-</div>
</div>
<button id="btnChangeName" style="font-size:11px; padding:4px 8px;">åå‰å¤‰æ›´</button>
</div>
<div id="titleRankingJobs"></div>
<div id="titleRankingList">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>
</div>
<!-- ================= ãƒ•ã‚§ãƒ¼ã‚º1ï¼šãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦æº–å‚™ ================= -->
<div id="phase1" style="display:none;">
<h2 id="phase1Title">ãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦</h2>
<div id="accountNamePhase1" style="margin:6px 0; opacity:0.9;"></div>
<div id="roomCodeArea" style="margin:6px 0; display:none;">
<input id="roomCodeInput" inputmode="numeric" maxlength="4" placeholder="ãƒ«ãƒ¼ãƒ ç•ªå·(4æ¡)" style="width:160px; text-align:center; padding:6px;"/>
</div>
<input id="name_phase1" placeholder="åå‰" style="display:none;"/>
<button id="btnConnectPhase1">æ¥ç¶š</button>
<button id="btnCancelRandom">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
<!-- â˜… ã“ã“ã«è¿½åŠ  -->
<div id="jobSelectArea"></div>
<p id="connectStatus"></p>
<!-- ========================= -->
<!-- CPUè·æ¥­é¸æŠï¼ˆCPUæˆ¦ã®ã¿è¡¨ç¤ºï¼‰ -->
<!-- ========================= -->
<div id="cpuJobArea" style="margin-top:8px; display:none;">
<label for="cpuJob">CPUã®è·æ¥­ï¼š</label>
<select id="cpuJob">
<option value="">ãƒ©ãƒ³ãƒ€ãƒ </option>
<option value="æˆ¦å£«">æˆ¦å£«</option>
<option value="é¨å£«">é¨å£«</option>
<option value="åƒ§ä¾¶">åƒ§ä¾¶</option>
<option value="ç›—è³Š">ç›—è³Š</option>
<option value="é­”å°å£«">é­”å°å£«</option>
<option value="å¼“å…µ">å¼“å…µ</option>
<option value="é™°é™½å¸«">é™°é™½å¸«</option>
<option value="éŒ¬é‡‘è¡“å¸«">éŒ¬é‡‘è¡“å¸«</option>
<option value="äººå½¢ä½¿ã„">äººå½¢ä½¿ã„</option>
</select>
<div id="cpuTurnOrderArea" style="margin-top:8px;">
<label>å…ˆæ”»ãƒ»å¾Œæ”»ï¼š</label>
<select id="cpuTurnOrder">
<option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
<option value="first">è‡ªåˆ†ãŒå…ˆæ”»</option>
<option value="second">CPUãŒå…ˆæ”»</option>
</select>
</div>
</div>
<!-- ================= è·æ¥­è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆbodyç›´ä¸‹ï¼‰ ================= -->
<div id="jobDetailPopup" style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,0.7);
            justify-content:center; align-items:center;
            z-index:9999;">
<div style="background:#2b2b2b; padding:20px; border-radius:10px;
              width:420px; max-height:80%; overflow-y:auto;">
<h3 id="jobDetailTitle">è·æ¥­è©³ç´°</h3>
<div id="jobDetailBody" style="font-size:13px; line-height:1.6; white-space:pre-line;">
</div>
<div style="text-align:right; margin-top:10px;">
<button onclick="closeJobDetail()">é–‰ã˜ã‚‹</button>
</div>
</div>
</div>
</div>
<button id="btnBackToMenu" style="display:none; margin-bottom:10px;">
  ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
</button>
<!-- ================= ãƒ•ã‚§ãƒ¼ã‚º2ï¼šãƒãƒˆãƒ«ç”»é¢ ================= -->
<div id="phase2" style="display:none;">
<!-- â˜… ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ -->
<div id="battleStage">
<!-- â˜… ãƒ©ã‚¦ãƒ³ãƒ‰ / ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºï¼ˆä¸­å¤®ä¸Šï¼‰ -->
<div id="roundTurnInfo">
<div id="roundLabel">ãƒ©ã‚¦ãƒ³ãƒ‰ 0</div>
<div id="turnLabel">ã‚¿ãƒ¼ãƒ³ 0</div>
</div>
<!-- ===== å·¦é™£å–¶ï¼ˆè‡ªåˆ†ï¼‰ ===== -->
<div class="side side-self">
<!-- â˜… ã‚­ãƒ£ãƒ©ï¼‹è£…å‚™ã‚’ã¾ã¨ã‚ã‚‹ -->
<div class="main-unit">
<div class="sprite player" id="playerSprite">
<div class="hp-bar">
<div class="hp-fill" id="playerHpFill"></div>
</div>
<div class="sprite-label-row">
<div class="sprite-label">ã‚ãªãŸ</div>
<div class="buff-strip buff-strip-sprite" data-side="self" id="buffStripSelf"></div>
</div>
</div>
<!-- â˜… é€šå¸¸è£…å‚™è¡¨ç¤ºï¼ˆè‡ªåˆ†ï¼‰ -->
<div class="equip-area">
<div class="equip-slot empty" title="é€šå¸¸è£…å‚™ï¼ˆæœªè£…å‚™ï¼‰">
          è£…å‚™
        </div>
</div>
<!-- â˜… ç‰¹æ®Šè£…å‚™ï¼ˆè‡ªåˆ†ï¼‰ â† ã“ã“ãŒæ­£è§£ -->
<div class="special-equip-area" data-side="self"></div>
</div>
<!-- â˜… äººå½¢ã¯æ¨ªï¼ˆä¸­å¤®å¯„ã‚Šï¼‰ -->
<div class="sprite doll" id="dollSprite" style="display:none;">
<div class="hp-bar doll-bar">
<div class="hp-fill doll" id="dollHpFill"></div>
</div>
<div class="sprite-label">äººå½¢</div>
<!-- â˜… äººå½¢ä¸‹ãƒ»ç‰¹æ®Šè£…å‚™ç”¨ -->
<div class="special-equip-area doll" data-side="self"></div>
</div>
</div>
<!-- ===== å³é™£å–¶ï¼ˆç›¸æ‰‹ï¼‰ ===== -->
<div class="side side-enemy">
<!-- â˜… äººå½¢ï¼ˆä¸­å¤®å¯„ã‚Šï¼‰ -->
<div class="sprite doll enemy" id="dollSpriteEnemy" style="display:none;">
<div class="hp-bar doll-bar">
<div class="hp-fill doll enemy" id="enemyDollHpFill"></div>
</div>
<div class="sprite-label">äººå½¢</div>
<div class="special-equip-area doll enemy" data-side="enemy"></div>
</div>
<!-- â˜… ã‚­ãƒ£ãƒ©ï¼‹è£…å‚™ -->
<div class="main-unit">
<div class="sprite enemy" id="enemySprite">
<div class="hp-bar">
<div class="hp-fill enemy" id="enemyHpFill"></div>
</div>
<div class="sprite-label-row">
<div class="sprite-label">ç›¸æ‰‹</div>
<div class="buff-strip buff-strip-sprite" data-side="enemy" id="buffStripEnemy"></div>
</div>
</div>
<!-- â˜… é€šå¸¸è£…å‚™è¡¨ç¤ºï¼ˆç›¸æ‰‹ï¼‰ -->
<div class="equip-area enemy">
<div class="equip-slot empty" title="é€šå¸¸è£…å‚™ï¼ˆæœªè£…å‚™ï¼‰">
          è£…å‚™
        </div>
</div>
<div class="special-equip-area enemy" data-side="enemy"></div>
</div>
</div>
</div> <!-- â˜…â˜…â˜… â† battleStage ã‚’ã“ã“ã§é–‰ã˜ã‚‹ï¼ˆé‡è¦ï¼‰ -->
<!-- ===== ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè‡ªåˆ† / ç›¸æ‰‹ï¼‰ ===== -->
<div class="status-area">
<div class="status-simple" id="my-status-simple"></div>
<div id="action-area">
<button disabled="" id="atkBtn" onclick="attack()">æ”»æ’ƒ</button>
<button disabled="" id="skillBtn" onclick="openSkillUI()">ã‚¹ã‚­ãƒ«</button>
<button disabled="" id="lvupBtn" onclick="tryLevelUp()">LvUP</button>
<button disabled="" id="itemBtn" onclick="openItemUI()">æŒã¡ç‰©</button>
<button disabled="" id="shopBtn" onclick="openShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
</div>
<div class="status-simple" id="enemy-status-simple"></div>
</div>
<div class="log-container">
<div class="log-box" id="battleBox"><div class="log-title">âš” æˆ¦é—˜ãƒ­ã‚°</div></div>
<div class="log-box" id="systemBox"><div class="log-title">â–¶ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div></div>
<div class="log-box" id="debugBox"><div class="log-title">ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</div></div>
</div>
<!-- ================= ã‚¹ã‚­ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="skillPopup">
<div id="skillBox">
<h3>ã‚¹ã‚­ãƒ«ä¸€è¦§</h3>
<div id="skillList"></div>
<button onclick="closeSkillUI()">é–‰ã˜ã‚‹</button>
</div>
</div>
<!-- â–¼ ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
<div id="itemCategoryPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999;">
<div style="background:#2b2b2b; padding:20px; border-radius:10px; width:260px;">
<h3>ã‚«ãƒ†ã‚´ãƒªé¸æŠ</h3>
<button onclick="openItemCategory('item')">ã‚¢ã‚¤ãƒ†ãƒ </button><br/><br/>
<button onclick="openItemCategory('equip')">è£…å‚™</button><br/><br/>
<button onclick="openItemCategory('special')">ç‰¹æ®Šè£…å‚™</button><br/><br/>
<button onclick="closeItemCategory()">é–‰ã˜ã‚‹</button>
</div>
</div>
<!-- ================= ã‚¢ã‚¤ãƒ†ãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="itemPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999;">
<div id="itemBox" style="background:#2b2b2b; padding:20px; border-radius:10px; width:380px; max-height:80vh; display:flex; flex-direction:column;">
<h3 id="itemPopupTitle">ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</h3>
<div id="itemList" style="overflow-y:auto; flex:1; margin-bottom:12px;"></div>
<button onclick="closeItemUI()">é–‰ã˜ã‚‹</button>
</div>
</div>
<!-- â˜… è¿½åŠ ï¼šã‚·ãƒ§ãƒƒãƒ—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div class="popup" id="shopPopup" style="display:none;">
<div class="popup-inner">
<h3>ã‚·ãƒ§ãƒƒãƒ—</h3>
<div id="shopList"></div>
<!-- â˜… ã“ã“ã«ç§»å‹•ã•ã›ã‚‹ï¼ˆpopup ã¨é€£å‹•ã—ã¦æ¶ˆãˆã‚‹ï¼‰ -->
<button onclick="rerollShop()">ã‚·ãƒ§ãƒƒãƒ—æ›´æ–°(5ã‚³ã‚¤ãƒ³)</button>
<button onclick="closeShopUI()">é–‰ã˜ã‚‹</button>
</div>
</div>
<!-- ================= ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="statusDetailPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999;">
<div style="background:#2b2b2b; padding:20px; border-radius:10px; width:420px;">
<h3 id="statusDetailTitle">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°</h3>
<div id="statusDetailBody" style="font-size:13px; line-height:1.6;"></div>
<div style="text-align:right; margin-top:10px;">
<button onclick="closeStatusDetail()">é–‰ã˜ã‚‹</button>
</div>
</div>
</div>

<!-- ================= ä¸­å¤®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ±ç”¨ãƒˆãƒ¼ã‚¹ãƒˆï¼‰ ================= -->
<div id="centerToast" style="display:none; position:fixed; inset:0;
  justify-content:center; align-items:center; z-index:99998; pointer-events:none;">
  <div id="centerToastBox" style="
    max-width: 82vw;
    background: rgba(0,0,0,0.75);
    border: 1px solid #666;
    border-radius: 10px;
    padding: 12px 16px;
    font-weight: 700;
    letter-spacing: 0.3px;
    text-align: center;
    transform: translateY(-6px);
    opacity: 0;
    transition: opacity 180ms ease, transform 180ms ease;">
    Toast
  </div>
</div>

<!-- ================= å‹åˆ©/æ•—åŒ—æ¼”å‡ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ================= -->
<div id="resultOverlay" style="display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.78); justify-content:center; align-items:center;
  z-index:99999;">
<div id="resultPanel" style="text-align:center; padding:22px 26px;
    border-radius:14px; background:rgba(20,20,20,0.95);
    border:1px solid rgba(255,255,255,0.18);
    box-shadow:0 10px 40px rgba(0,0,0,0.55);
    min-width:320px;">
<div id="resultTitle" style="font-size:34px; font-weight:900; letter-spacing:0.18em;
      margin-bottom:10px;">çµæœ</div>
<div id="resultSub" style="font-size:13px; opacity:0.85; margin-bottom:18px;">
      å¯¾æˆ¦ãŒçµ‚äº†ã—ã¾ã—ãŸ
    </div>
<button onclick="backToMenuFromResult()" style="padding:8px 16px;">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
</div>
</div>
<script>

// ====================
// â˜… ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
// ====================
const DEBUG_MODE = false; // â† é–‹ç™ºä¸­ true / é€šå¸¸ãƒ—ãƒ¬ã‚¤ false

// ==================== ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç† ====================
const PHASE = {
  MODE_SELECT: 0,
  RANDOM_READY: 1,
  BATTLE: 2
};

let currentPhase = PHASE.MODE_SELECT;

function setPhase(p) {
  currentPhase = p;

  document.getElementById("phase0").style.display =
    p === PHASE.MODE_SELECT ? "block" : "none";

  document.getElementById("phase1").style.display =
    p === PHASE.RANDOM_READY ? "block" : "none";

  document.getElementById("phase2").style.display =
    p === PHASE.BATTLE ? "block" : "none";

  if (p === PHASE.RANDOM_READY) {
    // â˜… è·æ¥­æœªé¸æŠæ™‚ã¯æ¥ç¶šãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ãªã„ã‚ˆã†ã«ã™ã‚‹
    const btn = document.getElementById("btnConnectPhase1");
    if (btn) btn.disabled = !selectedJobId;

    // refresh job record from server, then re-render cards
    refreshSummary().then(() => renderJobCards());
  }

  if (p === PHASE.MODE_SELECT) {
    // refresh title UI (ranking + name)
    setAccountNameUI();
    fetchAndRenderRanking(currentRankingJob);
  }

  // â˜… ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åæ˜ ï¼ˆã“ã“ã‹ã‚‰ï¼‰
  if (DEBUG_MODE) {
    document.body.classList.add("debug");
  } else {
    document.body.classList.remove("debug");
  }
  // â˜… ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åæ˜ ï¼ˆã“ã“ã¾ã§ï¼‰

}


/* ====================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
==================== */

let currentItemCategory = null;
let isItemUIOpen = false; // â˜… è¿½åŠ 
let ws;
let myTurn = false;
let myJob = null;
let myLevel = 1;
let pendingArrowItem = null;   // â˜… è¿½åŠ ï¼šè£…å‚™å¾…ã¡ã®çŸ¢
let battleEnded = false;

// ====================
// â˜… ã‚¹ã‚­ãƒ«æ®‹ã‚Šå›æ•°ï¼ˆserver ã® status_simple.skill_remaining ã‚’åæ˜ ï¼‰
// ====================
window.skillRemaining = { 1: 1, 2: 1, 3: 1 };

// ====================
// â˜… ãƒ©ã‚¦ãƒ³ãƒ‰ / ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºç”¨ã‚«ã‚¦ãƒ³ã‚¿
// ====================
let roundCount = 0; // è‡ªåˆ†ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã« +1
let turnCount = 0;  // èª°ã‹ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã« +1

function resetRoundTurnCounter() {
  roundCount = 0;
  turnCount = 0;
  updateRoundTurnUI();
}

function updateRoundTurnUI() {
  const roundEl = document.getElementById("roundLabel");
  const turnEl  = document.getElementById("turnLabel");
  if (roundEl) roundEl.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${roundCount}`;
  if (turnEl)  turnEl.textContent  = `ã‚¿ãƒ¼ãƒ³ ${turnCount}`;
}


// ==================== ç’°å¢ƒè‡ªå‹•åˆ¤å®š ====================
// ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆfile://, localhostï¼‰ã‹ã©ã†ã‹
const IS_LOCAL =
  location.protocol === "file:" ||
  location.hostname === "localhost";

// WebSocket æ¥ç¶šå…ˆã‚’è‡ªå‹•åˆ‡æ›¿
const WS_URL = IS_LOCAL
  ? "ws://localhost:8080"
  : "wss://cardbattle-server.onrender.com";

console.log("ENV:", IS_LOCAL ? "LOCAL" : "PRODUCTION");
console.log("WS_URL:", WS_URL);

// HTTP API base (for ranking/summary/name registration)
const API_BASE = IS_LOCAL
  ? "http://localhost:8080"
  : "https://cardbattle-server.onrender.com";

// ================= Account (localStorage + server) =================
const LS_ACCOUNT_ID = "gs_account_id";
const LS_ACCOUNT_NAME = "gs_account_name";

const LS_JOB_RECORD_KEY = (aid) => `gs_job_record_${aid}`;

function loadLocalJobRecord(aid) {
  try {
    const raw = localStorage.getItem(LS_JOB_RECORD_KEY(aid));
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || typeof obj !== "object") return null;
    return obj;
  } catch (e) {
    console.warn("loadLocalJobRecord failed:", e);
    return null;
  }
}

function saveLocalJobRecord(aid, jobs) {
  try {
    localStorage.setItem(LS_JOB_RECORD_KEY(aid), JSON.stringify(jobs || {}));
  } catch (e) {
    console.warn("saveLocalJobRecord failed:", e);
  }
}

function mergeJobRecords(serverJobs, localJobs) {
  const out = { ...(serverJobs || {}) };
  const l = localJobs || {};
  for (const [job, rec] of Object.entries(l)) {
    const s = out[job];
    const su = Number(s?.updatedAt ?? 0) || 0;
    const lu = Number(rec?.updatedAt ?? 0) || 0;
    const hasLocalProgress =
      (Number(rec?.wins ?? 0) || 0) + (Number(rec?.losses ?? 0) || 0) > 0 ||
      (Number(rec?.rating ?? 1000) || 1000) !== 1000;
    const hasServerProgress =
      (Number(s?.wins ?? 0) || 0) + (Number(s?.losses ?? 0) || 0) > 0 ||
      (Number(s?.rating ?? 1000) || 1000) !== 1000;

    // å„ªå…ˆé †ä½ï¼š
    // 1) updatedAt ãŒæ–°ã—ã„æ–¹
    // 2) ã‚µãƒ¼ãƒãŒâ€œåˆæœŸåŒ–çŠ¶æ…‹â€ã£ã½ã„ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆ
    if (!s) {
      out[job] = rec;
    } else if (lu > su) {
      out[job] = rec;
    } else if (!hasServerProgress && hasLocalProgress) {
      out[job] = rec;
    }
  }
  return out;
}

window.accountId = null;
window.accountName = null;
window.jobRecord = {}; // per job: {wins, losses, rating}

function validateNameClient(name) {
  if (typeof name !== "string") return { ok: false, reason: "åå‰ãŒä¸æ­£ã§ã™" };
  if (/[\n\r\t]/.test(name)) return { ok: false, reason: "æ”¹è¡Œãƒ»ã‚¿ãƒ–ã¯ç¦æ­¢ã§ã™" };
  if (name !== name.trim()) return { ok: false, reason: "å…ˆé ­ãƒ»æœ«å°¾ã‚¹ãƒšãƒ¼ã‚¹ã¯ç¦æ­¢ã§ã™" };
  if (/ {2,}/.test(name)) return { ok: false, reason: "é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã¯ç¦æ­¢ã§ã™" };
  const len = [...name].length;
  if (len < 2 || len > 12) return { ok: false, reason: "åå‰ã¯2ã€œ12æ–‡å­—ã§ã™" };
  return { ok: true };
}

function uuid() {
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  // fallback
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === "x" ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

async function apiPost(path, body) {
  const r = await fetch(API_BASE + path, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  return r.json();
}

async function apiGet(path) {
  const r = await fetch(API_BASE + path);
  return r.json();
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (c) => {
    switch (c) {
      case "&": return "&amp;";
      case "<": return "&lt;";
      case ">": return "&gt;";
      case '"': return "&quot;";
      case "'": return "&#39;";
      default: return c;
    }
  });
}

function setAccountNameUI() {
  const t = document.getElementById("titleAccountName");
  if (t) t.textContent = `åå‰ï¼š${window.accountName || "-"}`;
  const p1 = document.getElementById("accountNamePhase1");
  if (p1) p1.textContent = `åå‰ï¼š${window.accountName || "-"}`;
}

async function ensureAccount() {
  let aid = localStorage.getItem(LS_ACCOUNT_ID);
  let aname = localStorage.getItem(LS_ACCOUNT_NAME);

  if (!aid) {
    aid = uuid();
    localStorage.setItem(LS_ACCOUNT_ID, aid);
  }

  if (!aname) {
    while (true) {
      const input = prompt("åˆå›ãƒ­ã‚°ã‚¤ãƒ³ï¼šåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ2ã€œ12æ–‡å­—ï¼‰");
      if (input === null) {
        // cancel -> default name
        aname = "Player";
        break;
      }
      const name = String(input);
      const v = validateNameClient(name);
      if (!v.ok) {
        alert(v.reason);
        continue;
      }
      aname = name;
      break;
    }
    localStorage.setItem(LS_ACCOUNT_NAME, aname);
  }


window.accountId = aid;
window.accountName = aname;

// localStorage ã‹ã‚‰è·æ¥­åˆ¥æˆ¦ç¸¾ã‚’å…ˆã«å¾©å…ƒï¼ˆã‚µãƒ¼ãƒãŒè½ã¡ã¦ã„ã¦ã‚‚è¡¨ç¤ºã§ãã‚‹ï¼‰
const localJobs = loadLocalJobRecord(window.accountId);
if (localJobs) {
  window.jobRecord = localJobs;
}

setAccountNameUI();

  // register (server-side)
  try {
    await apiPost("/api/account/register", {
      account_id: window.accountId,
      name: window.accountName,
      backup_jobs: window.jobRecord
    });
  } catch (e) {
    console.warn("register failed:", e);
  }
}

async function refreshSummary() {
  if (!window.accountId) return;
  try {
    const data = await apiGet(`/api/account/summary?account_id=${encodeURIComponent(window.accountId)}`);
    
if (data?.ok && data.jobs) {
  const localJobs = loadLocalJobRecord(window.accountId) || {};
  const merged = mergeJobRecords(data.jobs, localJobs);
  window.jobRecord = merged;
  saveLocalJobRecord(window.accountId, merged);

  // ç”»é¢åæ˜ 
  renderTitleMyStats(currentRankingJob);
  if (document.getElementById("jobSelectArea")) {
    renderJobCards();
  }
}
  } catch (e) {
    console.warn("summary failed:", e);
    // ã‚µãƒ¼ãƒå–å¾—ã«å¤±æ•—ã—ã¦ã‚‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚’è¡¨ç¤º
    const localJobs = loadLocalJobRecord(window.accountId);
    if (localJobs) {
      window.jobRecord = localJobs;
      renderTitleMyStats(currentRankingJob);
      if (document.getElementById("jobSelectArea")) {
        renderJobCards();
      }
    }
  }
}

// ================= Title Ranking UI =================
let currentRankingJob = "æˆ¦å£«";

function renderRankingButtons() {
  const box = document.getElementById("titleRankingJobs");
  if (!box) return;
  box.innerHTML = "";
  JOB_LIST.forEach(j => {
    const b = document.createElement("button");
    b.textContent = j.name;
    b.onclick = () => { fetchAndRenderRanking(j.name); };
    box.appendChild(b);
  });
}

function renderRankingList(data) {
  const box = document.getElementById("titleRankingList");
  const lbl = document.getElementById("titleRankingJobLabel");
  if (lbl) lbl.textContent = `${currentRankingJob} ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;

  if (!box) return;
  if (!data?.ok) {
    box.textContent = "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
    return;
  }

  const rows = (data.top || []).map(r => {
    return `
      <div class="title-rank-row">
        <div class="left">${r.rank}. ${escapeHtml(r.name)}</div>
        <div class="right">ãƒ¬ãƒ¼ãƒˆ ${r.rating}</div>
      </div>
    `;
  }).join("");

  box.innerHTML = rows || "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
}


function renderTitleMyStats(jobName) {
  const el = document.getElementById("titleMyStats");
  if (!el) return;

  const rec = window.jobRecord?.[jobName] ?? null;
  const wins = Number(rec?.wins ?? 0) || 0;
  const losses = Number(rec?.losses ?? 0) || 0;
  const rating = Number(rec?.rating ?? 1000) || 1000;
  const rank = getRankByWins(wins);
  const nextNeed = getNextRankNeed(wins);

  const needText =
    nextNeed === null ? "ï¼ˆMAXï¼‰" : `ï¼ˆæ¬¡Rã¾ã§ ${Math.max(0, nextNeed - wins)} å‹ï¼‰`;

  el.innerHTML = `
    ã‚ãªãŸã®æˆç¸¾ï¼š
    <span class="cyber-accent">R${rank}</span>
    / ${wins}å‹${losses}æ•—
    / ãƒ¬ãƒ¼ãƒˆ ${rating}
    <span class="cyber-muted">${needText}</span>
  `;
}async function fetchAndRenderRanking(jobName) {
  currentRankingJob = jobName;
  renderTitleMyStats(jobName);
  try {
    const data = await apiGet(`/api/ranking?job=${encodeURIComponent(jobName)}`);
    renderRankingList(data);
  } catch (e) {
    console.warn("ranking failed:", e);
    renderRankingList({ ok: false });
  }
}

async function changeNameFlow() {
  const input = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ2ã€œ12æ–‡å­—ï¼‰", window.accountName || "");
  if (input === null) return;
  const name = String(input);
  const v = validateNameClient(name);
  if (!v.ok) {
    alert(v.reason);
    return;
  }

  try {
    const data = await apiPost("/api/account/change_name", {
      account_id: window.accountId,
      name
    });

    if (!data?.ok) {
      if (data?.nextNameChangeAt) {
        const d = new Date(data.nextNameChangeAt);
        alert(`${data.reason}
æ¬¡å›å¤‰æ›´å¯èƒ½ï¼š${d.toLocaleString()}`);
      } else {
        alert(data?.reason || "å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      return;
    }

    window.accountName = name;
    localStorage.setItem(LS_ACCOUNT_NAME, name);
    setAccountNameUI();
    await fetchAndRenderRanking(currentRankingJob);
  } catch (e) {
    console.warn("change name failed:", e);
    alert("å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ================= è·æ¥­å®šç¾© =================
const JOB_LIST = [
  {
    id: 1, name: "æˆ¦å£«", atk: 23, def: 10, coin: 10,
    stats: { luck: 1, burst: 3, difficulty: 1, stability: 5 }
  },
  {
    id: 2, name: "é¨å£«", atk: 20, def: 13, coin: 10,
    stats: { luck: 1, burst: 2, difficulty: 2, stability: 5 }
  },
  {
    id: 3, name: "åƒ§ä¾¶", atk: 20, def: 10, coin: 10,
    stats: { luck: 2, burst: 2, difficulty: 3, stability: 4 }
  },
  {
    id: 4, name: "ç›—è³Š", atk: 20, def: 10, coin: 15,
    stats: { luck: 5, burst: 4, difficulty: 4, stability: 2 }
  },
  {
    id: 5, name: "é­”å°å£«", atk: 20, def: 10, coin: 10,
    stats: { luck: 3, burst: 5, difficulty: 4, stability: 2 }
  },
  {
    id: 6, name: "é™°é™½å¸«", atk: 20, def: 10, coin: 10,
    stats: { luck: 4, burst: 3, difficulty: 5, stability: 2 }
  },
  {
    id: 7, name: "éŒ¬é‡‘è¡“å¸«", atk: 20, def: 10, coin: 10,
    stats: { luck: 3, burst: 4, difficulty: 5, stability: 2 }
  },
  {
    id: 8, name: "å¼“å…µ", atk: 10, def: 10, coin: 10,
    stats: { luck: 2, burst: 4, difficulty: 3, stability: 3 }
  },
  {
    id: 9, name: "äººå½¢ä½¿ã„", atk: 1, def: 10, coin: 10,
    stats: { luck: 4, burst: 5, difficulty: 5, stability: 1 }
  }
];

// ================= è·æ¥­è©³ç´°ï¼ˆãƒ˜ãƒ«ãƒ—ï¼ãƒ’ãƒ³ãƒˆç”¨ï¼‰ =================

// å…¨è·æ¥­å…±é€šèª¬æ˜
const COMMON_JOB_DESCRIPTION = `
ã€ã‚¿ãƒ¼ãƒ³(T)ã€‘
ã‚¿ãƒ¼ãƒ³ç¶™ç¶šåŠ¹æœã¯è‡ªèº«ã¨ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ä¸¡æ–¹ã§ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã€‚ãŠäº’ã„ã®ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«æ®‹ã‚Šç¶™ç¶šã‚¿ãƒ¼ãƒ³æ¸›å°‘

ã€ãƒ©ã‚¦ãƒ³ãƒ‰(R)ã€‘
ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã§ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã€‚è‡ªèº«ã®ã‚¿ãƒ¼ãƒ³ãŒå›ã£ã¦ãã‚‹ã”ã¨ã«ãƒ©ã‚¦ãƒ³ãƒ‰+1ã€‚ãƒ©ã‚¦ãƒ³ãƒ‰ç¶™ç¶šåŠ¹æœã¯ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹æ™‚ã«æ®‹ã‚Šç¶™ç¶šãƒ©ã‚¦ãƒ³ãƒ‰æ¸›å°‘

ã€ã‚³ã‚¤ãƒ³ã€‘
ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚10ã‚³ã‚¤ãƒ³é…å¸ƒã€‚

ã€EXPã€‘
è‡ªèº«ã®ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«10é…å¸ƒã€‚

ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã€‘
ãƒ¬ãƒ™ãƒ«2å¿…è¦EXP:40ã€ãƒ¬ãƒ™ãƒ«3å¿…è¦EXP:50ã€‚æœ€å¤§ãƒ¬ãƒ™ãƒ«3
ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åŸºç¤æ”»æ’ƒåŠ›ãŒä¸ŠãŒã‚‹ã€‚ãƒ¬ãƒ™ãƒ«2åŸºç¤æ”»æ’ƒåŠ›+3ã€ãƒ¬ãƒ™ãƒ«3åŸºç¤æ”»æ’ƒåŠ›+5
æ‰€æŒEXPãŒå¿…è¦EXPã¾ã§è²¯ã¾ã‚‹ã¨EXPã‚’æ¶ˆè²»ã—ã¦è‡ªå‹•ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã€‚
ã‚³ã‚¤ãƒ³ã¨EXPã®åˆè¨ˆãŒå¿…è¦EXPã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã‚³ã‚¤ãƒ³ã‚’ä¸è¶³EXPåˆ†æ”¯æ‰•ã„ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚

ã€ã‚·ãƒ§ãƒƒãƒ—ã€‘
æ¯ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹æ™‚ã«æ›´æ–°ã•ã‚Œã‚‹ã€‚ã‚³ã‚¤ãƒ³ã‚’æ”¯æ‰•ã†ã“ã¨ã§ã‚‚æ›´æ–°å¯èƒ½ã€‚

ã€ã‚¢ã‚¤ãƒ†ãƒ ã€‘
æ¯ã‚¿ãƒ¼ãƒ³2ã¤ã¾ã§ä½¿ç”¨ã§ãã‚‹ã€‚åŠ¹æœã¯é‡ã­æ›ã‘å¯èƒ½ã€‚

ã€è£…å‚™ã€‘
1ã¤ã¾ã§è£…å‚™å¯èƒ½ã€è£…å‚™ä¸­æ°¸ç¶šçš„ã«åŠ¹æœãŒé©ç”¨ã•ã‚Œã‚‹ã€‚

ã€ç‰¹æ®Šè£…å‚™ã€‘
è·æ¥­å°‚ç”¨ã®è£…å‚™ã€é€šå¸¸è£…å‚™ã¨ã¯åˆ¥æ ã€‚ç›—ã¾ã‚Œãªã„ã€‚
`;

// è·æ¥­åˆ¥è©³ç´°
const JOB_DESCRIPTIONS = {

  1: { // æˆ¦å£«
    name: "æˆ¦å£«",
    skills: {
      1: "ç›¸æ‰‹ã®é˜²å¾¡åŠ›ã‚’ç„¡è¦–ã—ã¦20ãƒ€ãƒ¡ãƒ¼ã‚¸",
      2: "ç›¸æ‰‹ã®é˜²å¾¡åŠ›ã‚’ç„¡è¦–ã—ã¦30ãƒ€ãƒ¡ãƒ¼ã‚¸+3Ræ”»æ’ƒåŠ›+3ã‚¢ãƒƒãƒ—",
      3: "ç›¸æ‰‹ã®é˜²å¾¡åŠ›ã‚’ç„¡è¦–ã—ã¦10+è‡ªèº«ã®æ”»æ’ƒåŠ›åˆè¨ˆåˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸"
    },
    playstyle: `
å¸¸æ™‚åŸºç¤æ”»æ’ƒåŠ›+3
`
  },

  2: { // é¨å£«
    name: "é¨å£«",
    skills: {
      1: "20ãƒ€ãƒ¡ãƒ¼ã‚¸+4Ré˜²å¾¡åŠ›+2ã‚¢ãƒƒãƒ—",
      2: "15ãƒ€ãƒ¡ãƒ¼ã‚¸+3Ré˜²å¾¡åŠ›+4ã‚¢ãƒƒãƒ—",
      3: "25+è‡ªèº«ã®é˜²å¾¡åŠ›åˆè¨ˆåˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸"
    },
    playstyle: `
å¸¸æ™‚åŸºç¤é˜²å¾¡åŠ›+3
`
  },

  3: { // åƒ§ä¾¶
    name: "åƒ§ä¾¶",
    skills: {
      1: "è‡ªèº«ã®HP27å›å¾©",
      2: "è‡ªèº«ã®HPã‚’32å›å¾©ï¼†ãƒ‡ãƒãƒ•è§£é™¤",
      3: "è‡ªèº«ã®HPã‚’37å›å¾©ï¼†ãƒ‡ãƒãƒ•è§£é™¤"
    },
    playstyle: `
è‡ªèº«ã®å›å¾©åŠ¹æœãŒ+3

`
  },

  4: { // ç›—è³Š
    name: "ç›—è³Š",
    skills: {
      1: "25ãƒ€ãƒ¡ãƒ¼ã‚¸+ç›¸æ‰‹ã®æŒã¡ç‰©ã‚’1ã¤ç›—ã‚€",
      2: "25+è‡ªèº«ã®æ‰€æŒã—ã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ æ•°Ã—2ãƒ€ãƒ¡ãƒ¼ã‚¸+ç›¸æ‰‹ã®æŒã¡ç‰©ã‚’1ã¤ç›—ã‚€",
      3: "æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…¨ä½¿ç”¨"
    },
    playstyle: `
åˆæœŸã‚³ã‚¤ãƒ³+5

ã€ç›—ã‚€ã€‘
ç›¸æ‰‹ã®æŒã¡ç‰©ã®é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ ã¾ãŸã¯é€šå¸¸è£…å‚™ã‚’å¥ªã†ã€‚ãŸã ã—ç›¸æ‰‹ã®æŒã¡ç‰©ã«ç›—ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã€è‡ªåˆ†ã®ã‚·ãƒ§ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰å¥ªã†ã€‚
`
  },

  5: { // é­”å°å£«
    name: "é­”å°å£«",
    skills: {
      1: "é­”åŠ›ã‚’20å›å¾©(1å›ã®ã¿)",
      2: "é­”åŠ›ã‚’30æ¶ˆè²»ã—ã¦30ãƒ€ãƒ¡ãƒ¼ã‚¸(å¿…è¦é­”åŠ›30ä»¥ä¸Š)",
      3: "é­”åŠ›ã‚’å…¨ã¦æ¶ˆè²»ã—ã¦æ¶ˆè²»é­”åŠ›-30ãƒ€ãƒ¡ãƒ¼ã‚¸(å¿…è¦é­”åŠ›60ä»¥ä¸Š)"
    },
    playstyle: `
é­”åŠ›ã‚’æŒã¤ã€‚    
ã‚·ãƒ§ãƒƒãƒ—ã«3ç¨®é¡ã®é­”å°å£«å°‚ç”¨ã‚¢ã‚¤ãƒ†ãƒ ã¨4ç¨®é¡ã®é­”å°å£«å°‚ç”¨è£…å‚™ãŒä¸¦ã¶ã‚ˆã†ã«ãªã‚‹ã€‚
åŒã˜ç¨®é¡ã®é­”å°å£«è£…å‚™ã¯1ã¤ã¾ã§è£…å‚™å¯èƒ½ã€‚

ã€é­”åŠ›ã€‘
åˆæœŸé­”åŠ›0
æœ€å¤§200ã¾ã§ãŸã‚ã‚‹ã“ã¨ãŒã§ãã€å¿…è¦é­”åŠ›ãŒã‚ã‚Œã°ä½•åº¦ã§ã‚‚ã‚¹ã‚­ãƒ«ã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã€‚

ã€é­”å°å£«ã‚¢ã‚¤ãƒ†ãƒ ã€‘
ãƒ»é­”åŠ›æ°´(å°ãƒ»ä¸­ãƒ»å¤§)ï¼šä¾¡æ ¼10ãƒ»15ãƒ»20/é­”åŠ›ã‚’10ãƒ»20ãƒ»30å›å¾©

ã€é­”å°å£«è£…å‚™ã€‘
ãƒ»é­”å°å£«ã®æ–:ä¾¡æ ¼ï¼š15/æ¯ãƒ©ã‚¦ãƒ³ãƒ‰é­”åŠ›+2/æ¯ãƒ©ã‚¦ãƒ³ãƒ‰ã‚³ã‚¤ãƒ³+3
ãƒ»é­”å°å£«ã®ãƒ­ãƒ¼ãƒ–ï¼šä¾¡æ ¼ï¼š10/æ¯ãƒ©ã‚¦ãƒ³ãƒ‰é­”åŠ›+3/é˜²å¾¡+2
ãƒ»é­”å°å£«ã®æŒ‡è¼ª:ä¾¡æ ¼ï¼š10/æ¯ãƒ©ã‚¦ãƒ³ãƒ‰é­”åŠ›+3/æ¯ãƒ©ã‚¦ãƒ³ãƒ‰HP+2
ãƒ»å¤ä»£é­”å°æ›¸:ä¾¡æ ¼ï¼š25/æ¯ãƒ©ã‚¦ãƒ³ãƒ‰é­”åŠ›+5/ã‚¹ã‚­ãƒ«ãŒé˜²å¾¡è²«é€š
`
  },

  6: { // é™°é™½å¸«
    name: "é™°é™½å¸«",
    skills: {
      1: "ä¸‹ç´šå¼ç¥ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§1ä½“å¬å–šã™ã‚‹ã€‚",
      2: "ä¸Šç´šã¾ãŸã¯ä¸‹ç´šã®å¼ç¥ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§1ä½“å¬å–šã™ã‚‹ã€‚",
      3: "ä¸Šç´šã¾ãŸã¯ä¸‹ç´šã®å¼ç¥ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§2ä½“å¬å–šã™ã‚‹ã€‚(åŒã˜å¼ç¥ã¯å‡ºãªã„)"
    },
    playstyle: `
ãªã—
`,
    shikigami: [
      "(ä¸‹ç´š)çŒ«åˆï¼šç›¸æ‰‹ã®ã‚¹ã‚­ãƒ«ã‚’2ãƒ©ã‚¦ãƒ³ãƒ‰å°å°ã™ã‚‹",
      "(ä¸‹ç´š)ç„æ­¦ï¼šæ¬¡ã«å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ç„¡åŠ¹åŒ–ï¼†3ãƒ©ã‚¦ãƒ³ãƒ‰é˜²å¾¡åŠ›+5",
      "(ä¸‹ç´š)çƒå¤©ç‹—ï¼š3ãƒ©ã‚¦ãƒ³ãƒ‰ã®é–“è¿½æ’ƒãŒç™ºç”Ÿã€è‡ªèº«ã®æ”»æ’ƒåŠ›åˆè¨ˆÃ—0.5+5ãƒ€ãƒ¡ãƒ¼ã‚¸",
      "(ä¸‹ç´š)é¬¼ç«ï¼š5ã‚¿ãƒ¼ãƒ³ã®é–“ãŠäº’ã„ã®è¡Œå‹•å¾Œã«é˜²å¾¡è²«é€šã®5ãƒ€ãƒ¡ãƒ¼ã‚¸",
      "(ä¸Šç´š)ä¹å°¾ï¼šé˜²å¾¡ç„¡è¦–30ãƒ€ãƒ¡ãƒ¼ã‚¸+ç›¸æ‰‹ã®è£…å‚™ä¸­ã®è£…å‚™ç ´å£Š+ç›¸æ‰‹ã®ãƒãƒ•åŠ¹æœã‚’è§£é™¤",
      "(ä¸Šç´š)ç™½ç«œï¼š30+è‡ªèº«ã®é˜²å¾¡åŠ›åˆè¨ˆå›å¾©"
      
    ]
  },

  7: { // éŒ¬é‡‘è¡“å¸«
    name: "éŒ¬é‡‘è¡“å¸«",
    skills: {
      1: "ãƒ©ãƒ³ãƒ€ãƒ ãªé€šå¸¸è£…å‚™ã‚’2ã¤ç”Ÿæˆ",
      2: "æ‰€æŒã¾ãŸã¯è£…å‚™ã—ã¦ã„ã‚‹è£…å‚™ã®â˜…ã‚’+1",
      3: "æ‰€æŒã¾ãŸã¯è£…å‚™ã—ã¦ã„ã‚‹è£…å‚™ã‚’3ã¤ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã³åˆæˆã—ç‰¹æ®Šæ­¦å™¨ã‚’ä½œã‚‹"
    },
    playstyle: `
ã‚·ãƒ§ãƒƒãƒ—ã®è£…å‚™ãŒ2å‰²å¼•ãã®å€¤æ®µã§è²·ãˆã‚‹ã€‚

ã€ç‰¹æ®Šæ­¦å™¨ã«ã¤ã„ã¦ã€‘
åˆæˆã—ãŸæ­¦å™¨ã®åŠ¹æœã‚’ã™ã¹ã¦è¶³ã—ç®—ã—ãŸèƒ½åŠ›ã«ãªã‚‹ã€‚

`
  },

  8: { // å¼“å…µ
    name: "å¼“å…µ",
    skills: {
      1: "3ãƒ©ã‚¦ãƒ³ãƒ‰ã®é–“è¿½æ’ƒå›æ•°ãŒ+1ã€‚",
      2: "çŸ¢ã®è£…å‚™æ +1ï¼†3Rè¿½æ’ƒå›æ•°+1",
      3: "ã™ã¹ã¦ã®çŸ¢ãŒé˜²å¾¡è²«é€šåŠ¹æœã‚’å¾—ã‚‹ã€‚"
    },
    playstyle: `
ã‚·ãƒ§ãƒƒãƒ—ã«çŸ¢ãŒå‡ºç¾ã™ã‚‹ã€‚

ã€è¿½æ’ƒã€‘
å¼“å…µã¯æ”»æ’ƒæ™‚ã«æ”»æ’ƒåŠ›ã§ã¯ãªãçŸ¢ã®åŠ¹æœã‚’å‚ç…§ã™ã‚‹ã€‚
çŸ¢ã®åˆæœŸã‚¹ãƒ­ãƒƒãƒˆã¯1æœ¬ã€‚å¯¾æˆ¦é–‹å§‹æ™‚ã«æ™®é€šã®çŸ¢ã‚’è£…å‚™ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã€‚

`,
    arrows: [
      "æ™®é€šã®çŸ¢ï¼š15ãƒ€ãƒ¡ãƒ¼ã‚¸ã®è¿½æ’ƒ",
      "æ¯’ã®çŸ¢ï¼š15ãƒ€ãƒ¡+æ¯’ä»˜ä¸(3ãƒ€ãƒ¡ãƒ¼ã‚¸Ã—2ãƒ©ã‚¦ãƒ³ãƒ‰)",
      "æ°·çµã®çŸ¢ï¼š 15ãƒ€ãƒ¡ãƒ¼ã‚¸ã®è¿½æ’ƒ+æ°·çµä»˜ä¸(ç›¸æ‰‹ã®æ”»æ’ƒåŠ›-2ã€ç´¯ç©åŠ¹æœ)",
      "åæ’ƒã®çŸ¢ï¼š10+å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®è¢«ãƒ€ãƒ¡ã®åŠåˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ã®è¿½æ’ƒ",
      "ä¼šå¿ƒã®çŸ¢ï¼š20ãƒ€ãƒ¡ãƒ¼ã‚¸+è£…å‚™ã—ã¦ã„ã‚‹å…¨ã¦ã®çŸ¢ã«1ãƒ©ã‚¦ãƒ³ãƒ‰ã®é–“ä¼šå¿ƒç‡50% ä¼šå¿ƒãƒ€ãƒ¡+50%ä»˜ä¸"
    ]
  },

  9: { // äººå½¢ä½¿ã„
    name: "äººå½¢ä½¿ã„",
    skills: {
      1: "äººå½¢ã®è¡£è£…ã‚’1ã¤ã‚’é¸ã³ã€â˜…ã‚’+1",
      2: "è‡ªèº«ã®HPã‚’10ã®å€æ•°é¸ã‚“ã§æ¶ˆè²»(æœ€å¤§100)ã€æ¶ˆè²»ã—ãŸHPã®åŠåˆ†äººå½¢ã®è€ä¹…åŠ›ã‚’å›å¾©ã™ã‚‹",
      3: "äººå½¢ã‚’æš´èµ°çŠ¶æ…‹ã«ã—ã€ç ´å£Šã•ã‚Œã‚‹ã¾ã§è¡£è£…åŠ¹æœãŒ2å€ã«ãªã‚‹"
    },
    playstyle: `
ã‚·ãƒ§ãƒƒãƒ—ã«ã¯ä¿®ç†ã‚­ãƒƒãƒˆã¨è¡£è£…ã—ã‹ä¸¦ã°ãªããªã‚‹ã€‚
äººå½¢ãŒå£Šã‚Œã¦ã„ãªã„ã¨ããƒ€ãƒ¡ãƒ¼ã‚¸ã¯äººå½¢ãŒä»£ã‚ã‚Šã«å—ã‘ã€å£Šã‚Œã¦ã„ã‚‹ã¨ãã¯äººå½¢ä½¿ã„æœ¬ä½“ãŒ2å€ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã€‚

ã€ä¿®ç†ã‚­ãƒƒãƒˆã€‘
äººå½¢ãŒå£Šã‚Œã¦ã„ã‚‹ã¨ãã¯å¾©æ´»ã—äººå½¢ã®è€ä¹…åŠ›ã‚’15å›å¾©ã€å£Šã‚Œã¦ã„ãªã„ã¨ãã¯20å›å¾©ã€‚
äººå½¢ãŒå¾©æ´»ã—ãŸæ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¯äººå½¢ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãªã„ã€‚

ã€è¡£è£…ã€‘
4éƒ¨ä½ã«1ã¤ãšã¤è£…å‚™å¯èƒ½ã€‚
äººå½¢ãŒå£Šã‚ŒãŸæ™‚è£…å‚™ä¸­ã®è¡£è£…ã¯ã¼ã‚ã¼ã‚çŠ¶æ…‹ã«ãªã‚ŠåŠ¹æœãŒå¼±ä½“åŒ–ã•ã‚Œã‚‹ã€‚
äººå½¢ãŒå£Šã‚ŒãŸæ™‚è£…å‚™ä¸­ã®ã¼ã‚ã¼ã‚çŠ¶æ…‹ã®è¡£è£…ã¯æ¶ˆå¤±ã™ã‚‹ã€‚

ã€æš´èµ°çŠ¶æ…‹ã€‘
ã“ã®çŠ¶æ…‹ã§äººå½¢ãŒå£Šã‚Œã‚‹ã¨è‡ªèº«ã«é˜²å¾¡è²«é€š40ãƒ€ãƒ¡ãƒ¼ã‚¸ã€ç›¸æ‰‹ã«é˜²å¾¡è²«é€š20ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚
3Rã®é–“ç ´å£Šã•ã‚Œãªã‹ã£ãŸå ´åˆè‡ªçˆ†ã—ã€è‡ªèº«ã«é˜²å¾¡è²«é€š20ãƒ€ãƒ¡ãƒ¼ã‚¸ã€ç›¸æ‰‹ã«é˜²å¾¡è²«é€š20ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚
ã“ã®çŠ¶æ…‹ã§ã¯è€ä¹…åŠ›ã¯å›å¾©ã—ãªã„ã€‚
`,
    doll: `
åŸºç¤æ”»æ’ƒåŠ›13/åŸºç¤é˜²å¾¡åŠ›8/è€ä¹…åŠ›50
å¯¾æˆ¦é–‹å§‹æ™‚4éƒ¨ä½ã«ãƒ©ãƒ³ãƒ€ãƒ ãªâ˜…1è¡£è£…ã‚’è£…å‚™ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã€‚
äººå½¢ãŒå£Šã‚ŒãŸæ™‚è£…å‚™ä¸­ã®è¡£è£…ã¯ã¼ã‚ã¼ã‚çŠ¶æ…‹ã«ãªã‚ŠåŠ¹æœãŒå¼±ä½“åŒ–ã•ã‚Œã‚‹ã€‚
äººå½¢ãŒå£Šã‚ŒãŸæ™‚è£…å‚™ä¸­ã®ã¼ã‚ã¼ã‚çŠ¶æ…‹ã®è¡£è£…ã¯æ¶ˆå¤±ã™ã‚‹ã€‚


`
  }

};

function openJobDetail(jobId) {
  const data = JOB_DESCRIPTIONS[jobId];
  if (!data) return;

  document.getElementById("jobDetailTitle").textContent =
    `è·æ¥­è©³ç´°ï¼š${data.name}`;

  let html = "";

  // ================= å…±é€šèª¬æ˜ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ =================
  html += `
    <div style="margin-bottom:12px; border-bottom:1px solid #444;">
      <button
        onclick="toggleCommonJobDesc()"
        style="background:none; border:none; color:#9fd3ff; cursor:pointer;">
        â–¶ å…±é€šãƒ«ãƒ¼ãƒ«ãƒ»åŸºæœ¬èª¬æ˜
      </button>

      <div id="commonJobDesc"
           style="display:none; font-size:12px; line-height:1.6; margin-top:6px; white-space:pre-line;">
        ${COMMON_JOB_DESCRIPTION.trim()}
      </div>
    </div>
  `;

  // ================= ã‚¹ã‚­ãƒ« =================
  html += `<h4>ã‚¹ã‚­ãƒ«</h4><ul>`;
  for (const [k, v] of Object.entries(data.skills)) {
    html += `<li>ã‚¹ã‚­ãƒ«${k}ï¼š${v}</li>`;
  }
  html += `</ul>`;

  // ================= ç«‹ã¡å›ã‚Š / ãƒ‘ãƒƒã‚·ãƒ– =================
  html += `
    <h4>ãƒ‘ãƒƒã‚·ãƒ–åŠ¹æœ</h4>
    <div style="white-space:pre-line; margin-bottom:10px;">
      ${data.playstyle.trim()}
    </div>
  `;

  // ================= é™°é™½å¸«ï¼šå¼ç¥ =================
  if (data.shikigami) {
    html += `<h4>å¼ç¥ä¸€è¦§</h4><ul>`;
    data.shikigami.forEach(s => {
      html += `<li>${s}</li>`;
    });
    html += `</ul>`;
  }

  // ================= å¼“å…µï¼šçŸ¢ =================
  if (data.arrows) {
    html += `<h4>çŸ¢ä¸€è¦§</h4><ul>`;
    data.arrows.forEach(a => {
      html += `<li>${a}</li>`;
    });
    html += `</ul>`;
  }

  // ================= äººå½¢ä½¿ã„ï¼šäººå½¢ =================
  if (data.doll) {
    html += `
      <h4>äººå½¢ã«ã¤ã„ã¦</h4>
      <div style="white-space:pre-line;">
        ${data.doll.trim()}
      </div>
    `;
  }

  document.getElementById("jobDetailBody").innerHTML = html;
  document.getElementById("jobDetailPopup").style.display = "flex";
}

function toggleCommonJobDesc() {
  const el = document.getElementById("commonJobDesc");
  if (!el) return;

  const isOpen = el.style.display === "block";
  el.style.display = isOpen ? "none" : "block";
}

function closeJobDetail() {
  document.getElementById("jobDetailPopup").style.display = "none";
}

let selectedJobId = null;
let isConnecting = false; // â˜… ã“ã‚Œã‚’è¿½åŠ 

// ================================
// ãƒãƒƒãƒãƒ³ã‚°è¡¨ç¤ºï¼ˆç§’æ•°ï¼‰ & CPUè‡ªå‹•åˆ‡æ›¿
// ================================
let matchTimerId = null;
let matchSeconds = 0;
let autoCpuTriggered = false;
let roomTimeoutTriggered = false;
let cpuConnectFailTimerId = null;

window.matchMode = "random"; // "random" | "room" | "cpu"

function stopMatchTimer() {
  if (matchTimerId) {
    clearInterval(matchTimerId);
    matchTimerId = null;
  }
  matchSeconds = 0;
  autoCpuTriggered = false;
  roomTimeoutTriggered = false;
}

function clearCpuFailTimer() {
  if (cpuConnectFailTimerId) {
    clearTimeout(cpuConnectFailTimerId);
    cpuConnectFailTimerId = null;
  }
}

function updateMatchStatusText() {
  const status = document.getElementById("connectStatus");
  if (!status) return;
  if (!isConnecting) return;

  if (window.matchMode === "random") {
    status.textContent = `ãƒãƒƒãƒãƒ³ã‚°ä¸­... ${matchSeconds}ç§’`;
    return;
  }

  if (window.matchMode === "room") {
    status.textContent = `ãƒ«ãƒ¼ãƒ å¾…æ©Ÿä¸­... ${matchSeconds}ç§’`;
    return;
  }

  // CPU
  status.textContent = `CPUã¨æ¥ç¶šä¸­... ${matchSeconds}ç§’`;
}

function startMatchTimer() {
  stopMatchTimer();
  matchSeconds = 0;
  autoCpuTriggered = false;
  roomTimeoutTriggered = false;

  updateMatchStatusText();

  matchTimerId = setInterval(() => {
    matchSeconds += 1;

    // ãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦ã®ã¿ï¼š60ç§’è¶…ã§CPUã¸è‡ªå‹•åˆ‡æ›¿
    if (window.matchMode === "random" && !autoCpuTriggered && matchSeconds >= 30) {
      autoCpuTriggered = true;
      triggerAutoCpuMatch();
      // ä»¥é™ã‚‚ç§’æ•°ã¯æ•°ãˆç¶šã‘ã‚‹ï¼ˆè¡¨ç¤ºã¯ match_start ã§æ¶ˆãˆã‚‹ï¼‰
    }

    // ãƒ«ãƒ¼ãƒ å¯¾æˆ¦ã®ã¿ï¼š60ç§’çµŒéã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆCPUã¸ã¯è¡Œã‹ãªã„ï¼‰
    if (window.matchMode === "room" && !roomTimeoutTriggered && matchSeconds >= 60) {
      roomTimeoutTriggered = true;
      handleRoomTimeout();
      return;
    }

    updateMatchStatusText();
  }, 1000);
}

function handleRoomTimeout() {
  // ãƒ«ãƒ¼ãƒ å¯¾æˆ¦ï¼š1åˆ†å¾…ã£ã¦ã‚‚ç›¸æ‰‹ãŒã„ãªã„å ´åˆã¯æ¥ç¶šã‚’åˆ‡ã£ã¦å†æ¥ç¶šå¯èƒ½ã«ã™ã‚‹
  cleanupSocket();
  stopMatchTimer();
  clearCpuFailTimer();

  isConnecting = false;
  const btn = document.getElementById("btnConnectPhase1");
  if (btn) btn.disabled = false;

  const status = document.getElementById("connectStatus");
  if (status) status.textContent = "ç›¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
}

function cleanupSocket() {
  if (ws) {
    try { ws.close(); } catch (e) {}
    ws = null;
  }
}

function backToTitleWithError(message) {
  cleanupSocket();
  stopMatchTimer();
  clearCpuFailTimer();

  isConnecting = false;
  const btn = document.getElementById("btnConnectPhase1");
  if (btn) btn.disabled = false;

  const status = document.getElementById("connectStatus");
  if (status) status.textContent = message || "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™";

  setTimeout(() => {
    const st = document.getElementById("connectStatus");
    if (st) st.textContent = "";
    setPhase(PHASE.MODE_SELECT);
    refreshSummary();
    fetchAndRenderRanking(currentRankingJob);
  }, 1200);
}

function triggerAutoCpuMatch() {
  // 1åˆ†çµŒé â†’ CPUæˆ¦ã¸
  cleanupSocket();

  window.isCpuMode = true;
  window.matchMode = "cpu";
  // â˜… ãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦ã‹ã‚‰ã®è‡ªå‹•CPUï¼ˆãƒ¬ãƒ¼ãƒˆå¤‰å‹•å¯¾è±¡ï¼‰
  window.cpuKind = "auto";

  const roomArea = document.getElementById("roomCodeArea");
  if (roomArea) roomArea.style.display = "none";

  const cpuArea = document.getElementById("cpuJobArea");
  if (cpuArea) cpuArea.style.display = "none";

  const title = document.getElementById("phase1Title");
  if (title) title.textContent = "CPUæˆ¦ï¼ˆè‡ªå‹•ï¼‰";

  const status = document.getElementById("connectStatus");
  if (status) status.textContent = "1åˆ†çµŒéï¼šCPUã¨ãƒãƒƒãƒãƒ³ã‚°ã—ã¾ã™...";

  // CPUæ¥ç¶šãŒæˆç«‹ã—ãªã„å ´åˆã¯é€šä¿¡ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
  clearCpuFailTimer();
  cpuConnectFailTimerId = setTimeout(() => {
    if (isConnecting) {
      backToTitleWithError("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™");
    }
  }, 8000);

  joinCpu();
}


const RANK_THRESHOLDS = [
  10, 25, 50, 100, 200, 400, 600, 800, 1000
];

// ================= å‹åˆ©æ•° â†’ ãƒ©ãƒ³ã‚¯å¤‰æ› =================
function getRankByWins(wins) {
  if (wins >= 1000) return 10;
  if (wins >= 800)  return 9;
  if (wins >= 600)  return 8;
  if (wins >= 400)  return 7;
  if (wins >= 200)  return 6;
  if (wins >= 100)  return 5;
  if (wins >= 50)   return 4;
  if (wins >= 25)   return 3;
  if (wins >= 10)   return 2;
  return 1; // 0ã€œ9å‹
}

function getNextRankNeed(wins) {
  for (let i = 0; i < RANK_THRESHOLDS.length; i++) {
    if (wins < RANK_THRESHOLDS[i]) {
      return RANK_THRESHOLDS[i];
    }
  }
  return null; // MAXãƒ©ãƒ³ã‚¯
}

function renderJobBars(stats) {
  const MAX = 5;

  const map = [
    { key: "luck", label: "é‹è¦ç´ " },
    { key: "burst", label: "çˆ†ç™ºåŠ›" },
    { key: "difficulty", label: "é›£æ˜“åº¦" },
    { key: "stability", label: "å®‰å®šæ„Ÿ" }
  ];

  return map.map(m => {
    const v = stats[m.key] ?? 0;
    const percent = (v / MAX) * 100;

    return `
      <div class="job-bar-row">
        <div class="job-bar-label">${m.label}</div>
        <div class="job-bar-bg">
          <div class="job-bar-fill" style="width:${percent}%"></div>
        </div>
      </div>
    `;
  }).join("");
}

// ================= è·æ¥­ã‚«ãƒ¼ãƒ‰æç”» =================
function renderJobCards() {
  const area = document.getElementById("jobSelectArea");
  area.innerHTML = "";

  JOB_LIST.forEach(job => {

    const rec = window.jobRecord?.[job.name] ?? null;
    const wins = rec?.wins ?? 0;
    const rating = rec?.rating ?? 1000;
    const rank = getRankByWins(wins);
    const nextNeed = getNextRankNeed(wins);


    const card = document.createElement("div");
    card.className = "job-card";
    card.onclick = () => selectJob(job.id);

    card.innerHTML = `
      <div class="job-header">
        <span>${job.name}ï¼ˆR${rank}ï¼‰</span>

        <span class="job-rank-progress">
          ${
            nextNeed === null
              ? `${wins} å‹ï¼ˆMAXï¼‰`
              : `${wins} / ${nextNeed} å‹`
          }
          <br>
          ãƒ¬ãƒ¼ãƒˆ ${rating}
        </span>

        <button class="job-detail-btn"
          onclick="event.stopPropagation(); openJobDetail(${job.id})">
          è©³ç´°
        </button>
      </div>


      <div class="job-bars">
        ${renderJobBars(job.stats)}
      </div>

      <div class="job-stats">
        <div>åŸºç¤æ”»æ’ƒåŠ›ï¼š${job.atk}</div>
        <div>åŸºç¤é˜²å¾¡åŠ›ï¼š${job.def}</div>
        <div>åˆæœŸã‚³ã‚¤ãƒ³ï¼š${job.coin}</div>
      </div>
    `;


    area.appendChild(card);
  });
}

// ================= è·æ¥­é¸æŠ =================
function selectJob(jobId) {
  selectedJobId = jobId;

  document.querySelectorAll(".job-card")
    .forEach(c => c.classList.remove("selected"));

  const index = JOB_LIST.findIndex(j => j.id === jobId);
  if (index >= 0) {
    document.querySelectorAll(".job-card")[index]
      .classList.add("selected");
  }

  // â˜… è·æ¥­ã‚’é¸ã‚“ã ã‚‰æ¥ç¶šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ¥ç¶šä¸­ã¯é™¤ãï¼‰
  const btn = document.getElementById("btnConnectPhase1");
  if (btn && !isConnecting) btn.disabled = false;
}



// è·æ¥­å â†’ ã‚¹ã‚­ãƒ«ID å¤‰æ›
const JOB_ID_MAP = {
  "æˆ¦å£«": 1,
  "é¨å£«": 2,
  "åƒ§ä¾¶": 3,
  "ç›—è³Š": 4,
  "é­”å°å£«": 5,
  "é™°é™½å¸«": 6,
  "éŒ¬é‡‘è¡“å¸«": 7,
  "å¼“å…µ": 8,
  "äººå½¢ä½¿ã„": 9
};

/* ================= ã‚¹ã‚­ãƒ«å®šç¾©ï¼ˆã‚ãªãŸã®ä»•æ§˜ãã®ã¾ã¾ï¼‰ ================= */
const SKILLS = {
  1:[ {name:"ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒ©ãƒƒã‚·ãƒ¥",desc:"é˜²å¾¡ç„¡è¦–20ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"},
      {name:"ãƒ–ãƒ¬ã‚¤ãƒ–ãƒãƒ£ãƒ¼ã‚¸",desc:"é˜²å¾¡ç„¡è¦–30ï¼‹æ”»æ’ƒ+3ï¼ˆ3Rï¼‰"},
      {name:"ãƒ©ã‚¹ãƒˆãƒ–ãƒ¬ãƒ¼ãƒ‰",desc:"é˜²å¾¡ç„¡è¦–(10ï¼‹è‡ªèº«ã®æ”»æ’ƒåŠ›åˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ )"} ],
  2:[ {name:"ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯",desc:"20ï¼‹é˜²å¾¡åŠ›+2ï¼ˆ4Rï¼‰"},
      {name:"ã‚¢ã‚¤ã‚¢ãƒ³ãƒãƒ£ãƒ¼ã‚¸",desc:"15ï¼‹é˜²å¾¡åŠ›+4ï¼ˆ3Rï¼‰"},
      {name:"ã‚¸ãƒ£ã‚¹ãƒ†ã‚£ã‚¹ãƒ–ãƒ¬ãƒ¼ãƒ‰",desc:"25ï¼‹è‡ªèº«ã®é˜²å¾¡åŠ›åˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ "} ],
  3:[ {name:"ãƒ’ãƒ¼ãƒ«",desc:"HP27å›å¾©"},
      {name:"ãƒ‡ã‚£ã‚¹ãƒšãƒ«ãƒ’ãƒ¼ãƒ«",desc:"HP32ï¼‹ãƒ‡ãƒãƒ•è§£é™¤"},
      {name:"ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ’ãƒ¼ãƒ«",desc:"HP37ï¼‹ãƒ‡ãƒãƒ•è§£é™¤"} ],
  4:[ {name:"ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼†ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«",desc:"25ï¼‹ç›—ã‚€"},
      {name:"ãƒ€ã‚¬ãƒ¼ãƒ¬ã‚¤ãƒ‰",desc:"25+(ã‚¢ã‚¤ãƒ†ãƒ æ•°Ã—2)+ç›—ã‚€"},
      {name:"ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒ¼ã‚¹ãƒˆ",desc:"æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…¨ç™ºå‹•"} ],
  5:[ {name:"é­”åŠ›ãƒãƒ£ãƒ¼ã‚¸",desc:"é­”åŠ›+20ï¼ˆ1å›ã®ã¿ï¼‰"},
      {name:"ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¹ãƒˆ",desc:"é­”åŠ›30æ¶ˆè²»ãƒ»30ãƒ€ãƒ¡ãƒ¼ã‚¸"},
      {name:"ãƒ¡ãƒ†ã‚ªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ",desc:"é­”åŠ›å…¨æ¶ˆè²»â†’æ¶ˆè²»é­”åŠ›-30ãƒ€ãƒ¡ãƒ¼ã‚¸(å¿…è¦é­”åŠ›60ä»¥ä¸Š)"} ],
  6:[ {name:"å¼ç¥å¬å–šãƒ»åˆç´š",desc:"é¬¼ç«/çŒ«åˆ/ç„æ­¦/çƒå¤©ç‹—"},
      {name:"å¼ç¥å¬å–šãƒ»ä¸Šç´š",desc:"ä¹å°¾/ç™½é¾å«ã‚€å¼ç¥1ä½“"},
      {name:"äºŒé‡å¬å–š",desc:"å¼ç¥2ä½“åŒæ™‚å¬å–š"} ],
  7:[ {name:"éŒ¬æˆ",desc:"è£…å‚™ã‚’2ã¤ç”Ÿæˆ"},
      {name:"ç²¾éŒ¬",desc:"å…¨è£…å‚™â˜…+1"},
      {name:"ä¸‰é‡åˆæˆ",desc:"è£…å‚™3ã¤åˆæˆâ†’ç‰¹æ®Šæ­¦å™¨ç”Ÿæˆ"} ],
  8:[ {name:"é›†ä¸­å°„æ’ƒ",desc:"3Rè¿½æ’ƒ+1"},
      {name:"ç‹™ã„æ’ƒã¡ï¼‹çŸ¢æ‹¡å¼µ",desc:"çŸ¢ã®è£…å‚™æ +1ï¼†3Rè¿½æ’ƒ+1"},
      {name:"è²«é€šã®çŸ¢",desc:"å…¨çŸ¢ãŒé˜²å¾¡è²«é€šåŒ–"} ],
  9:[
    {
      name:"ä»•ç«‹ã¦ç›´ã—",
      desc:"äººå½¢ã®è¡£è£…ã‚’1ã¤ã‚’é¸ã³ã€â˜…ã‚’+1ã™ã‚‹ï¼ˆæœ€å¤§â˜…4ï¼‰"
    },
    {
      name:"ç”Ÿå‘½ç¸«åˆ",
      desc:"è‡ªèº«ã®HPã‚’æ¶ˆè²»ã—ã€äººå½¢ã®è€ä¹…åŠ›ã‚’å›å¾©ã™ã‚‹ï¼ˆHP0ä¸å¯ï¼‰"
    },
    {
      name:"äººå½¢æš´èµ°",
      desc:"äººå½¢ã‚’æš´èµ°çŠ¶æ…‹ã«ã—ã€ç ´å£Šã•ã‚Œã‚‹ã¾ã§è¡£è£…åŠ¹æœãŒ2å€ã«ãªã‚‹"
    },
  ],

};



/* ==================== ãƒ­ã‚°è¿½åŠ  ==================== */
function appendLog(boxId, className, text){
  const box=document.getElementById(boxId);
  const div=document.createElement("div");
  div.className="log-line "+className;
  div.textContent=text;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

// ============================
// æ¼”å‡ºï¼šæ•°å­—ãƒãƒƒãƒ—ã®æ®µç©ã¿ç®¡ç†
// ============================
const popupStacks = {
  self: 0,
  enemy: 0,
  self_doll: 0,
  enemy_doll: 0
};


function getSprites() {
  return {
    self: document.getElementById("playerSprite"),
    enemy: document.getElementById("enemySprite"),
    self_doll: document.getElementById("dollSprite"),
    enemy_doll: document.getElementById("dollSpriteEnemy"),
  };
}

function bumpStack(targetKey) {
  const idx = popupStacks[targetKey] ?? 0;
  popupStacks[targetKey] = idx + 1;

  // ä¸Šã«ãšã‚‰ã™ï¼ˆåŒæ™‚ç™ºç”Ÿã§é‡ãªã‚‰ãªã„ï¼‰
  const offsetPx = -idx * 18;

  setTimeout(() => {
    popupStacks[targetKey] = Math.max(0, (popupStacks[targetKey] ?? 1) - 1);
  }, 900);

  return offsetPx;
}

function spawnPopup(sprite, className, text, offsetPx) {
  if (!sprite) return;

  const el = document.createElement("div");
  el.className = className;
  el.textContent = text;
  el.style.top = `calc(40% + ${offsetPx}px)`;

  sprite.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

// ============================
// â˜… äººå½¢ä½¿ã„ï¼šäººå½¢ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæ›´æ–°ï¼ˆå…±é€šï¼‰
// ============================
function updateDollSprite(side, job, doll) {
  const isSelf = side === "self";

  const dollBox = document.getElementById(
    isSelf ? "dollSprite" : "dollSpriteEnemy"
  );
  const dollBar = document.getElementById(
    isSelf ? "dollHpFill" : "enemyDollHpFill"
  );

  if (!dollBox || !dollBar) return;

  // äººå½¢ä½¿ã„ä»¥å¤–ã¯å¸¸ã«éè¡¨ç¤º
  if (job !== "äººå½¢ä½¿ã„") {
    dollBox.style.display = "none";
    return;
  }

  // äººå½¢æƒ…å ±ãŒã¾ã æ¥ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
  if (!doll) return;

  // è¡¨ç¤º
  dollBox.style.display = "block";

  const ratio = doll.durability / doll.max_durability;
  const percent = Math.max(0, Math.min(100, ratio * 100));
  dollBar.style.width = `${percent}%`;

  // ç ´å£Šæ™‚ã®è¦‹ãŸç›®
  if (doll.is_broken) {
    dollBox.style.filter = "grayscale(1) brightness(0.6)";
  } else {
    dollBox.style.filter = "";
  }
}

// ============================
// â˜… é€šå¸¸è£…å‚™UIæ›´æ–°
// ============================
function updateNormalEquipUI(side, equipment) {
  const area = document.querySelector(
    side === "self"
      ? ".side-self .equip-slot"
      : ".side-enemy .equip-slot"
  );
  if (!area) return;

  // åˆæœŸåŒ–
  area.classList.remove("filled");
  area.classList.add("empty");
  area.innerHTML = "è£…å‚™";

  if (!equipment || equipment.length === 0) return;

  // 1æ ã®ã¿ä½¿ç”¨
  const eq = equipment[0];

  // æ–‡å­—åˆ— or ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸¡å¯¾å¿œ
  let name = "";
  let effect = "";

  if (typeof eq === "string") {
    name = eq;
    effect = "";
  } else {
    name = eq.name ?? "ä¸æ˜ãªè£…å‚™";
    effect = eq.effect_text ?? eq.effect ?? "";
  }

  area.classList.remove("empty");
  area.classList.add("filled");

  area.innerHTML = `
    è£…å‚™
    <div class="equip-tooltip">
      <b>${name}</b>
      ${effect ? `<br>${effect}` : ""}
    </div>
  `;
}

// ============================
// â˜… äººå½¢ç”¨ï¼šç‰¹æ®Šè£…å‚™HTMLç”Ÿæˆï¼ˆstatus_detail ã¨å…±é€šï¼‰
// ============================
function buildDollSpecialEquipHTML(doll) {
  if (!doll || !doll.costumes) {
    return "<div style='font-size:11px; opacity:0.6;'>è¡£è£…ãªã—</div>";
  }

  const parts = {
    head: "é ­",
    body: "èƒ´",
    leg:  "è„š",
    foot: "è¶³"
  };

  let html = "";

  for (const [part, label] of Object.entries(parts)) {
    const c = doll.costumes[part];

    if (c) {
      const cleanName = c.name
        ? c.name.replace(/^â˜…\d+/, "")
        : "è¡£è£…";

      html += `
        <div class="special-equip-slot filled active"
             title="â˜…${c.star ?? 1} ${cleanName}">
          ${label}
        </div>
      `;
    } else {
      html += `
        <div class="special-equip-slot empty">
          ${label}
        </div>
      `;
    }
  }

  return html;
}

// ============================
// â˜… äººå½¢è¡£è£…ï¼ˆè©³ç´°è¡¨ç¤ºç”¨HTMLï¼‰
// ============================
function buildDollCostumeHTML(doll) {
  if (!doll) return "";

  const partLabel = {
    head: "å¸½å­",
    body: "æœ",
    leg:  "ã‚ºãƒœãƒ³",
    foot: "é´"
  };

  const costumes = doll.costumes || {};
  const parts = ["head", "body", "leg", "foot"];

  const rows = parts.map(p => {
    const c = costumes[p];
    if (!c) {
      return `<div style="opacity:0.75;">${partLabel[p]}ï¼šãªã—</div>`;
    }

    const name = (typeof c === "string") ? c : (c.name || "ä¸æ˜ãªè¡£è£…");
    const effect = (typeof c === "object") ? (c.effect_text || c.effect || "") : "";

    return `
      <div style="margin-top:4px;">
        <b>${partLabel[p]}</b>ï¼š${name}
        ${effect ? `<div style="opacity:0.9; margin-left:8px;">${effect}</div>` : ""}
      </div>
    `;
  }).join("");

  return `
    <div style="margin-top:10px; padding-top:8px; border-top:1px solid #444;">
      <div style="color:#f6c; margin-bottom:4px;"><b>ğŸª† äººå½¢è¡£è£…</b></div>
      ${rows}
    </div>
  `;
}


// ============================
// â˜… ç‰¹æ®Šè£…å‚™UIæ›´æ–°
// ============================
function updateSpecialEquipUI(side, specialEquip) {

  // â˜… å‰å›æç”»ã‚’å®Œå…¨ã«ç ´æ£„ï¼ˆé‡è¦ï¼‰
  document
    .querySelectorAll(`.special-equip-area[data-side="${side}"]`)
    .forEach(a => a.innerHTML = "");

  // ã©ã“ã«æç”»ã™ã‚‹ã‹æ±ºå®š
  let area = null;

  if (!specialEquip) return;

  if (specialEquip.position === "under_doll") {
    area = document.querySelector(
      `.special-equip-area.doll[data-side="${side}"]`
    );
  } else {
    area = document.querySelector(
      `.special-equip-area[data-side="${side}"]:not(.doll)`
    );
  }

  if (!area) return;

  // åˆæœŸåŒ–
  area.innerHTML = "";

  if (!specialEquip.slots) return;

  for (const slot of specialEquip.slots) {

    const div = document.createElement("div");
    div.classList.add("special-equip-slot");

    // ãƒ­ãƒƒã‚¯æ 
    if (!slot.unlocked) {
      div.classList.add("locked");
      div.textContent = "Ã—";
      area.appendChild(div);
      continue;
    }

    // ç©ºæ 
    if (!slot.item) {
      div.classList.add("empty");
      div.textContent = slot.label;
      area.appendChild(div);
      continue;
    }

    // è£…å‚™ã‚ã‚Š
    div.classList.add("filled");
    div.classList.add("active"); // â˜… ã“ã“ã§ç‚¹ç¯

    // â˜… é€šå¸¸è£…å‚™ã¨åŒã˜ãã€ãƒ›ãƒãƒ¼ã§è©³ç´°ãŒå‡ºã‚‹ã‚ˆã† tooltip ã‚’å†…åŒ…
    const name = slot.item?.name ?? "ä¸æ˜ãªè£…å‚™";
    const effect = slot.item?.effect_text ?? slot.item?.effect ?? "";

    div.innerHTML = `
      ${slot.label}
      <div class="equip-tooltip">
        <b>${name}</b>
        ${effect ? `<br>${effect}` : ""}
      </div>
    `;

    area.appendChild(div);
  }
}


// ============================
// â˜… ãƒãƒ•UIï¼ˆã‚­ãƒ£ãƒ©ç®±ï¼‰
//   - data.buffs_ui ã‚’å—ã‘å–ã‚Šã€ã‚ãªãŸ/ç›¸æ‰‹ã®ç®±ã«è¡¨ç¤º
// ============================
function buffIconForKind(kind) {
  switch (kind) {
    case "atk_up":   return "ğŸ—¡ï¸";
    case "def_up":   return "ğŸ›¡ï¸";
    case "atk_down": return "ğŸ—¡ï¸";
    case "def_down": return "ğŸ›¡ï¸";
    case "freeze":   return "â„ï¸";
    default:          return "âœ¨";
  }
}

function updateBuffStrip(side, buffs) {
  const id = (side === "self") ? "buffStripSelf" : "buffStripEnemy";
  const area = document.getElementById(id);
  if (!area) return;

  const list = Array.isArray(buffs) ? buffs : [];
  if (list.length === 0) {
    area.innerHTML = "";
    area.style.display = "none";
    return;
  }

  area.style.display = "flex";
  area.innerHTML = "";

  for (const b of list) {
    const kind = b.kind ?? "other";
    const div = document.createElement("div");
    div.className = `buff-slot ${kind}`;
    div.innerHTML = `
      ${buffIconForKind(kind)}
      <div class="buff-tooltip">
        <b>${b.source ?? "ãƒãƒ•"}</b>
        ${b.text ? `<br>${b.text}` : ""}
      </div>
    `;
    area.appendChild(div);
  }
}


// ============================
// â˜… ä¸­å¤®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆ3ç§’ãªã©çŸ­æ™‚é–“è¡¨ç¤ºï¼‰
// ============================
let centerToastTimerId = null;

function showCenterToast(msg, ms = 3000) {
  const wrap = document.getElementById("centerToast");
  const box  = document.getElementById("centerToastBox");
  if (!wrap || !box) return;

  // é€£ç¶šè¡¨ç¤ºã¯ä¸Šæ›¸ã
  if (centerToastTimerId) {
    clearTimeout(centerToastTimerId);
    centerToastTimerId = null;
  }

  box.textContent = String(msg ?? "");
  wrap.style.display = "flex";

  // 1ãƒ•ãƒ¬ãƒ¼ãƒ é…ã‚‰ã›ã¦ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’åŠ¹ã‹ã›ã‚‹
  requestAnimationFrame(() => {
    box.style.opacity = "1";
    box.style.transform = "translateY(0px)";
  });

  centerToastTimerId = setTimeout(() => {
    box.style.opacity = "0";
    box.style.transform = "translateY(-6px)";
    setTimeout(() => {
      wrap.style.display = "none";
    }, 220);
  }, ms);
}

// ============================
// â˜… éˆ´SEï¼ˆWebAudioç°¡æ˜“ç”Ÿæˆï¼šè‘—ä½œæ¨©ãƒ•ãƒªãƒ¼ï¼‰
// ============================
function playBellSfx() {
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  if (!AudioCtx) return;

  const ctx = new AudioCtx();
  ctx.resume?.();

  const now = ctx.currentTime + 0.02;

  // ãã‚‰ã£ã¨ã—ãŸå€éŸ³ï¼ˆçŸ­ã‚ï¼‰
  const freqs = [1760, 2640, 3520]; // A6 + å€éŸ³
  const master = ctx.createGain();
  master.gain.value = 0.16;
  master.connect(ctx.destination);

  freqs.forEach((f, i) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();

    o.type = "sine";
    o.frequency.setValueAtTime(f, now);

    const t0 = now + i * 0.002;
    const t1 = t0 + 0.55;

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(1.0, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t1);

    o.connect(g);
    g.connect(master);

    o.start(t0);
    o.stop(t1 + 0.02);
  });

  // è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
  setTimeout(() => {
    try { ctx.close?.(); } catch {}
  }, 800);
}

// ============================
// â˜… å¯¾æˆ¦ä¸­BGMï¼ˆHiphopç³»ï¼šWebAudioè‡ªä½œ / ãƒ«ãƒ¼ãƒ—ï¼‰
//   - è‘—ä½œæ¨©ãƒ•ãƒªãƒ¼ï¼ˆç”ŸæˆéŸ³ï¼‰
//   - å‹æ•—ç¢ºå®š(battle_end)ã§åœæ­¢
// ============================
let battleBgmCtx = null;
let battleBgmTimerId = null;

function stopBattleBgm() {
  try {
    if (battleBgmTimerId) {
      clearInterval(battleBgmTimerId);
      battleBgmTimerId = null;
    }
    if (battleBgmCtx) {
      battleBgmCtx.close?.();
      battleBgmCtx = null;
    }
  } catch {}
}

// ç°¡æ˜“ãƒ‰ãƒ©ãƒ éŸ³æº
function _kick(ctx, t) {
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";
  o.frequency.setValueAtTime(120, t);
  o.frequency.exponentialRampToValueAtTime(48, t + 0.12);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(1.0, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

  o.connect(g);
  g.connect(ctx.destination);
  o.start(t);
  o.stop(t + 0.22);
}

function _noiseBuffer(ctx) {
  const len = ctx.sampleRate * 1.0;
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const data = buf.getChannelData(0);
  for (let i = 0; i < len; i++) data[i] = (Math.random() * 2 - 1);
  return buf;
}

let _cachedNoiseBuf = null;

function _snare(ctx, t) {
  if (!_cachedNoiseBuf) _cachedNoiseBuf = _noiseBuffer(ctx);

  const src = ctx.createBufferSource();
  src.buffer = _cachedNoiseBuf;

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 900;

  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.9, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);

  src.connect(hp);
  hp.connect(g);
  g.connect(ctx.destination);

  src.start(t);
  src.stop(t + 0.16);
}

function _hat(ctx, t) {
  if (!_cachedNoiseBuf) _cachedNoiseBuf = _noiseBuffer(ctx);

  const src = ctx.createBufferSource();
  src.buffer = _cachedNoiseBuf;

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.value = 8000;
  bp.Q.value = 0.8;

  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.25, t + 0.002);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);

  src.connect(bp);
  bp.connect(g);
  g.connect(ctx.destination);

  src.start(t);
  src.stop(t + 0.06);
}

// ãƒ™ãƒ¼ã‚¹ï¼ˆé¦–ãŒå‹•ãæ„Ÿã˜ï¼šè·³ã­ã‚‹16åˆ†ï¼‰
function _bass(ctx, t, freq) {
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  const lp = ctx.createBiquadFilter();

  o.type = "square";
  o.frequency.setValueAtTime(freq, t);

  lp.type = "lowpass";
  lp.frequency.value = 700;
  lp.Q.value = 0.6;

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.25, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

  o.connect(lp);
  lp.connect(g);
  g.connect(ctx.destination);

  o.start(t);
  o.stop(t + 0.2);
}

function playBattleBgm() {
  // äºŒé‡èµ·å‹•é˜²æ­¢
  stopBattleBgm();

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  if (!AudioCtx) return;

  battleBgmCtx = new AudioCtx();
  battleBgmCtx.resume?.();
  const ctx = battleBgmCtx;

  // 92 BPMï¼ˆã‚†ã£ãã‚Šã™ããšã€ãƒãƒªé‡è¦–ï¼‰
  const bpm = 92;
  const step = 60 / bpm / 4; // 16åˆ†
  const barSteps = 16;
  const startAt = ctx.currentTime + 0.06;

  // 2å°ç¯€ãƒ«ãƒ¼ãƒ—ï¼ˆ32stepï¼‰
  const patternSteps = 32;

  // ãƒ‰ãƒ©ãƒ ï¼šã‚­ãƒƒã‚¯/ã‚¹ãƒã‚¢/ãƒãƒƒãƒˆ
  const kickSteps = new Set([0, 7, 16, 23]);
  const snareSteps = new Set([4, 12, 20, 28]);

  // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆCmç³»ï¼‰
  const bassFreq = (n) => 32.703 * Math.pow(2, n/12); // C1åŸºæº–
  const bassNotes = [
    24, 24, 27, 24,  // C2, C2, Eb2, C2
    31, 31, 27, 24,  // G2, G2, Eb2, C2
    24, 24, 27, 24,
    29, 29, 27, 24
  ]; // 16stepåˆ†ï¼ˆ1å°ç¯€ï¼‰â†’2å°ç¯€ã§ç¹°ã‚Šè¿”ã—

  let stepIndex = 0;
  let nextTime = startAt;

  const scheduleAhead = 0.12; // å…ˆèª­ã¿
  const tick = () => {
    if (!ctx) return;
    const cur = ctx.currentTime;

    while (nextTime < cur + scheduleAhead) {
      const p = stepIndex % patternSteps;

      // ãƒ‰ãƒ©ãƒ 
      if (kickSteps.has(p)) _kick(ctx, nextTime);
      if (snareSteps.has(p)) _snare(ctx, nextTime);
      _hat(ctx, nextTime); // 16åˆ†ã§åˆ»ã‚€

      // ãƒ™ãƒ¼ã‚¹ï¼š8åˆ†ã€œ16åˆ†ã®è·³ã­ï¼ˆå¶æ•°stepä¸­å¿ƒï¼‰
      const bIdx = p % 16;
      const note = bassNotes[bIdx];
      if (p % 2 === 0) _bass(ctx, nextTime, bassFreq(note));

      stepIndex++;
      nextTime += step;
    }
  };

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©é–‹å§‹
  battleBgmTimerId = setInterval(tick, 25);
}

// ============================
// â˜… å‹åˆ©/æ•—åŒ—æ¼”å‡º
//   - è‘—ä½œæ¨©å›é¿ï¼šWebAudioã§ç°¡æ˜“BGMï¼ˆè‡ªä½œã®çŸ­ã„ãƒ¡ãƒ­ãƒ‡ã‚£ï¼‰
// ============================
let resultBgmCtx = null;
let resultBgmNodes = [];

function stopResultBgm() {
  try {
    for (const n of resultBgmNodes) {
      try { n.stop?.(); } catch {}
      try { n.disconnect?.(); } catch {}
    }
    resultBgmNodes = [];
    if (resultBgmCtx) {
      resultBgmCtx.close?.();
      resultBgmCtx = null;
    }
  } catch {}
}

function playResultBgm(type) {
  stopResultBgm();

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  if (!AudioCtx) return;

  resultBgmCtx = new AudioCtx();
  resultBgmCtx.resume?.();

  const ctx = resultBgmCtx;
  const now = ctx.currentTime + 0.02;

  // victory: æ˜ã‚‹ã„ä¸Šæ˜‡ / defeat: ä½ã‚ã®ä¸‹é™
  const seq = (type === "win")
    ? [523.25, 659.25, 783.99, 1046.5, 783.99]   // C5 E5 G5 C6 G5
    : [392.00, 329.63, 261.63, 220.00, 196.00];  // G4 E4 C4 A3 G3

  const dur = 0.16;

  const master = ctx.createGain();
  master.gain.value = 0.12;
  master.connect(ctx.destination);

  for (let i = 0; i < seq.length; i++) {
    const o = ctx.createOscillator();
    const g = ctx.createGain();

    o.type = "triangle";
    o.frequency.setValueAtTime(seq[i], now + i * dur);

    // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒã‚¤ã‚ºæŠ‘åˆ¶ï¼‰
    const t0 = now + i * dur;
    const t1 = t0 + dur;
    g.gain.setValueAtTime(0.0, t0);
    g.gain.linearRampToValueAtTime(1.0, t0 + 0.03);
    g.gain.linearRampToValueAtTime(0.0, t1);

    o.connect(g);
    g.connect(master);

    o.start(t0);
    o.stop(t1 + 0.02);

    resultBgmNodes.push(o, g);
  }
}

function showResultOverlay(result) {
  const ov = document.getElementById("resultOverlay");
  const title = document.getElementById("resultTitle");
  const sub = document.getElementById("resultSub");

  if (!ov || !title || !sub) return;

  if (result === "win") {
    title.textContent = "VICTORY";
    sub.textContent = "å‹åˆ©ã—ã¾ã—ãŸ";
    playResultBgm("win");
  } else if (result === "lose") {
    title.textContent = "DEFEAT";
    sub.textContent = "æ•—åŒ—ã—ã¾ã—ãŸ";
    playResultBgm("lose");
  } else {
    title.textContent = "DRAW";
    sub.textContent = "å¼•ãåˆ†ã‘";
  }

  ov.style.display = "flex";
}

function backToMenuFromResult() {
  stopResultBgm();
  const ov = document.getElementById("resultOverlay");
  if (ov) ov.style.display = "none";

  const btn = document.getElementById("btnBackToMenu");
  if (btn) btn.click();
}

// ============================================
// â˜… WebSocket å—ä¿¡å‡¦ç† å…±é€šåŒ–ï¼ˆCPUæˆ¦ / å¯¾äºº å…±é€šï¼‰
// ============================================
function attachWsHandlers() {

  ws.onerror = (e) => {
    appendLog("systemBox", "system-log", "âŒ ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
    console.error("WebSocket error:", e);

    // â˜… æ¥ç¶šå¤±æ•—æ™‚ã®ä¿é™ºå‡¦ç†
    isConnecting = false;

    const btn = document.getElementById("btnConnectPhase1");
    if (btn) btn.disabled = false;

    stopMatchTimer();
    clearCpuFailTimer();

    const status = document.getElementById("connectStatus");
    if (status) status.textContent = "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ";
  };


  ws.onmessage = (msg) => {
    console.log("[WS RECEIVE RAW]", msg.data);

    const data = JSON.parse(msg.data);

    // â˜… ãƒãƒƒãƒæˆç«‹ â†’ ãƒ•ã‚§ãƒ¼ã‚º2ã¸
    if (data.type === "match_start") {

      // â˜… è·æ¥­è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
      closeJobDetail();

      // â˜… ãƒãƒƒãƒãƒ³ã‚°æˆç«‹æ¼”å‡ºï¼ˆä¸­å¤®3ç§’ + éˆ´SEï¼‰
      showCenterToast("ãƒãƒƒãƒãƒ³ã‚°ã—ã¾ã—ãŸ", 3000);
      playBellSfx();

      // â˜… å¯¾æˆ¦ä¸­BGMï¼ˆHiphopç³»ï¼šè‡ªä½œWebAudioï¼‰é–‹å§‹
      playBattleBgm();



      // â˜… æ¥ç¶šå®Œäº†ãªã®ã§ãƒ•ãƒ©ã‚°è§£é™¤
      isConnecting = false;

      stopMatchTimer();
      clearCpuFailTimer();

      const btn = document.getElementById("btnConnectPhase1");
      if (btn) btn.disabled = false;

      const status = document.getElementById("connectStatus");
      if (status) status.textContent = "";

      setPhase(PHASE.BATTLE);

      // â˜… ãƒ©ã‚¦ãƒ³ãƒ‰/ã‚¿ãƒ¼ãƒ³ã‚«ã‚¦ãƒ³ã‚¿åˆæœŸåŒ–
      resetRoundTurnCounter();
      return;
    }

    // â˜… ã‚µãƒ¼ãƒã‹ã‚‰ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é€šçŸ¥
    if (data.type === "popup") {
      showCenterToast(data.msg ?? "", Number(data.ms ?? 2500));
      if (data.sfx === "bell") playBellSfx();
      return;
    }


    // ===============================
    // â†“â†“â†“ ã“ã“ã‹ã‚‰ä¸‹ã¯ã€Œå…ƒã® ws.onmessage ã®ä¸­èº«ã€ã‚’
    //     ãã®ã¾ã¾å…¨éƒ¨ã‚³ãƒ”ãƒšã—ã¦ç½®ãæ›ãˆã‚‹ â†“â†“â†“
    // ===============================
    // äººå½¢ä½¿ã„ï¼šç€ã›æ›¿ãˆéƒ¨ä½é¸æŠï¼ˆç°¡æ˜“UIï¼‰
    if (data.type === "request_doll_part_select") {

      const parts = [
        { key: "head", label: "å¸½å­" },
        { key: "body", label: "æœ" },
        { key: "leg",  label: "ã‚ºãƒœãƒ³" },
        { key: "foot", label: "é´" }
      ];

      const popup = document.getElementById("skillPopup");
      const list  = document.getElementById("skillList");

      let html = `<div style="font-weight:bold; margin-bottom:8px;">
        å¼·åŒ–ã™ã‚‹éƒ¨ä½ã‚’é¸ã‚“ã§ãã ã•ã„
      </div>`;

      for (const p of parts) {
        html += `
          <button onclick="selectDollPart('${p.key}')" style="margin:4px;">
            ${p.label}
          </button><br>
        `;
      }

      list.innerHTML = html;
      popup.style.display = "flex";
      return;
    }


    if (data.type === "status_simple") {

      // ================================
      // â˜… ã‚¹ã‚­ãƒ«æ®‹ã‚Šå›æ•°ï¼ˆselfå´ã®ã¿ï¼‰
      // ================================
      if (data.side === "self" && data.skill_remaining) {
        window.skillRemaining = data.skill_remaining;
      }




      const box =
        data.side === "self"
          ? document.getElementById("my-status-simple")
          : document.getElementById("enemy-status-simple");

      let html = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="display:flex; align-items:center; gap:8px;">
            <strong>${data.side === "self" ? "ã‚ãªãŸ" : "ç›¸æ‰‹"}</strong>
            <span style="opacity:0.9;">${data.job ?? "?"}</span>
          </div>
          <button type="button" onclick="openStatusDetail('${data.side}')">è©³ç´°</button>
        </div>

        <div style="display:flex; gap:8px; margin-top:6px;">
          
          <!-- å·¦ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
          <div style="flex:1;">
            <div>HP: ${data.hp} / ${data.max_hp}</div>
            <div>æ”»æ’ƒ: ${data.attack}</div>
            <div>é˜²å¾¡: ${data.defense}</div>
            <div>ã‚³ã‚¤ãƒ³: ${data.coins}</div>
            <div>Lv: ${data.level}</div>
            ${
              data.mana !== null
                ? `<div>é­”åŠ›: ${data.mana} / ${data.mana_max}</div>`
                : ""
            }
          </div>

          <!-- å³ï¼šäººå½¢ -->
          <div style="flex:1; border-left:1px solid #555; padding-left:6px;">
            ${
              data.doll
                ? `
                  <div style="color:#f6c;">ğŸª† äººå½¢</div>
                  <div>è€ä¹…: ${data.doll.durability} / ${data.doll.max_durability}
                    ${data.doll.is_broken ? "ï¼ˆç ´å£Šï¼‰" : ""}
                  </div>
                  <div>æ”»æ’ƒ: ${data.doll.attack}</div>
                  <div>é˜²å¾¡: ${data.doll.defense}</div>
                `
                : `<div style="color:#777;"></div>`
            }
          </div>

        </div>
      `;

      box.innerHTML = html;
      // â˜… é€šå¸¸è£…å‚™UIåæ˜ 
      updateNormalEquipUI(data.side, data.equipment);
      // â˜… ç‰¹æ®Šè£…å‚™UI
      updateSpecialEquipUI(data.side, data.special_equip);

      // â˜… ãƒãƒ•UIï¼ˆã‚­ãƒ£ãƒ©ç®±ï¼‰
      updateBuffStrip(data.side, data.buffs_ui ?? []);

      // ============================
      // â˜… HPãƒãƒ¼æ›´æ–°
      // ============================
      const ratio = data.hp / data.max_hp;
      const percent = Math.max(0, Math.min(100, ratio * 100));

      if (data.side === "self") {
        const bar = document.getElementById("playerHpFill");
        if (bar) bar.style.width = `${percent}%`;
      } else {
        const bar = document.getElementById("enemyHpFill");
        if (bar) bar.style.width = `${percent}%`;
      }      
      // ============================
      // â˜… äººå½¢ä½¿ã„ï¼šäººå½¢ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæ›´æ–°ï¼ˆself / enemyï¼‰
      // ============================
      updateDollSprite(data.side, data.job, data.doll);

      return;
    }


    if (data.type === "status_detail") {
      console.log("status_detail data:", data);

      document.getElementById("statusDetailTitle").textContent =
        data.side === "self" ? "ã‚ãªãŸã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" : "ç›¸æ‰‹ã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹";

      let html = `
        <div><b>HP</b>: ${data.hp} / ${data.max_hp}</div>
        <div><b>æ”»æ’ƒåŠ›</b>: ${data.attack}</div>
        <div><b>é˜²å¾¡åŠ›</b>: ${data.defense}</div>
        <div><b>ã‚³ã‚¤ãƒ³</b>: ${data.coins}</div>
        <div><b>Lv</b>: ${data.level}</div>
        <div><b>EXP</b>: ${data.exp}</div>
      `;

      if (data.mana !== null) {
        html += `<div><b>é­”åŠ›</b>: ${data.mana} / ${data.mana_max}</div>`;
      }

      if (data.equipment?.length) {
        html += `<hr><b>è£…å‚™ä¸­</b><br>${data.equipment.join("<br>")}`;
      }

      if (data.buffs?.length) {
        html += `<hr><b>ãƒãƒ•</b><br>${data.buffs.join("<br>")}`;
      }

      if (data.shikigami?.length) {
        html += `<hr><b>å¼ç¥</b><br>${data.shikigami.join("<br>")}`;
      }
      // ================================
      // â˜… äººå½¢ä½¿ã„ï¼šè£…å‚™ä¸­ã®è¡£è£…è¡¨ç¤º
      // ================================
      if (data.doll && data.doll.costumes) {

        html += `<hr><b>ğŸª† äººå½¢</b><br>`;
        html += `è€ä¹…ï¼š${data.doll.durability} / ${data.doll.max_durability}`;
        if (data.doll.is_broken) {
          html += `ï¼ˆç ´å£Šï¼‰`;
        }
        html += `<br>`;
        html += `æ”»æ’ƒï¼š${data.doll.attack}<br>`;
        html += `é˜²å¾¡ï¼š${data.doll.defense}<br><br>`;

        html += `<b>äººå½¢ã®è¡£è£…</b><br>`;

        html += buildDollCostumeHTML(data.doll);

      }


      document.getElementById("statusDetailBody").innerHTML = html;
      document.getElementById("statusDetailPopup").style.display = "flex";
      return;
    }

    /* --- HP --- */
    if (data.type === "hp") {
      const hpEl = document.getElementById("hp");
      if (hpEl) {
        hpEl.textContent =
          `ã‚ãªãŸã®HP ${data.myHP} / æ•µHP ${data.enemyHP}`;
      }
      return;
}


    
    if (data.type === "job_info") {
        window.myJob = data.job;
        console.log("My Job = ", window.myJob);
        return;
    }

    if (data.type === "mana_info") {
      const nowEl = document.getElementById("mana_now");
      const maxEl = document.getElementById("mana_max");
      const blockEl = document.getElementById("mana_block");

      if (nowEl && maxEl) {
        nowEl.textContent = data.mana;
        maxEl.textContent = data.mana_max;
      }

      if (blockEl) {
        blockEl.style.display = "block";
      }
      return;
    }

    /* --- EXP --- */
    if (data.type === "exp_info") {
      const expEl = document.getElementById("exp");
      if (expEl) {
        expEl.textContent = data.exp;
      }
      return;
    }


    /* --- ãƒ¬ãƒ™ãƒ«æƒ…å ± --- */
    if (data.type === "level_info") {
      myLevel = data.level;

      const levelEl = document.getElementById("level");
      if (levelEl) {
        levelEl.textContent = "Lv " + data.level;
      }

      const lvupBtn = document.getElementById("lvupBtn");
      if (lvupBtn) {
        lvupBtn.disabled = !myTurn;
      }

      return;
    }



    if (data.type === "item_list") {
      window.itemList = data.items;

      // â˜…ã€Œé–‹ã„ã¦ã„ã‚‹ã¨ãã ã‘ã€å†æç”»
      if (isItemUIOpen && currentItemCategory !== null) {
        openItemCategory(currentItemCategory);
      }
      return;
    }


    
    if (data.type === "status_info") {

      window.arrowSlots = data.arrow_slots ?? 1;
      const isOnmyoji = (window.myJob === "é™°é™½å¸«");

      // ---------------------------
      // å¼ç¥è¡¨ç¤ºï¼ˆé™°é™½å¸«ï¼‰
      // ---------------------------
      let shikiHTML = "";
      if (isOnmyoji) {
        shikiHTML = `
          <div id="shikigami-list" style="margin-top:8px; font-size:12px; color:#6cf;">
            ${
              !data.shikigami || data.shikigami.length === 0
                ? "ï¼ˆå¼ç¥ãªã—ï¼‰"
                : data.shikigami.map(s => `${s}`).join("<br>")
            }
          </div>
        `;
      }

      // ---------------------------
      // äººå½¢è¡¨ç¤ºï¼ˆäººå½¢ä½¿ã„ï¼‰
      // ---------------------------
      let dollHTML = "";
      if (data.doll) {
        const state = data.doll.is_broken ? "ï¼ˆç ´å£Šï¼‰" : "";
        dollHTML = `
          <hr>
          <div style="margin-top:6px; color:#f6c;">
            ğŸª† äººå½¢è€ä¹…ï¼š${data.doll.durability} / ${data.doll.max_durability} ${state}
          </div>
        `;
      }

      const panel = document.getElementById("status-panel");
      if (!panel) return;

      panel.innerHTML = `
        æ”»æ’ƒåŠ›ï¼š${data.attack}<br>
        é˜²å¾¡åŠ›ï¼š${data.defense}<br>

        <div id="buff-list" style="margin-top:8px; font-size:12px; color:#ccc;">
          ${
            data.buffs.length === 0
              ? "ï¼ˆãƒãƒ•ãªã—ï¼‰"
              : data.buffs.map(b => `${b}`).join("<br>")
          }
        </div>

        ${shikiHTML}
        ${dollHTML}
      `;

      return;
    }





    // â˜…è¿½åŠ ï¼šã‚·ãƒ§ãƒƒãƒ—å•†å“ãƒªã‚¹ãƒˆå—ä¿¡
    if (data.type === "shop_list") {
        renderShop(data.items);
        return;
    }


    /* --- ã‚³ã‚¤ãƒ³ --- */
    if (data.type === "coin_info") {
      const coinEl = document.getElementById("coins");
      if (coinEl) {
        coinEl.textContent = data.coins;
      }
      return;
    }

    /* --- è‡ªåˆ†ã®ãƒ©ã‚¦ãƒ³ãƒ‰ --- */
    if(data.type==="your_turn"){
      myTurn = true;
      appendLog("systemBox","system-log", data.msg);

      // â˜… è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼šãƒ©ã‚¦ãƒ³ãƒ‰ +1 / ã‚¿ãƒ¼ãƒ³ +1
      roundCount++;
      turnCount++;
      updateRoundTurnUI();

      document.getElementById("atkBtn").disabled = false;
      document.getElementById("skillBtn").disabled = false;
      document.getElementById("lvupBtn").disabled = false; // å¸¸ã«æŠ¼ã›ã‚‹
      document.getElementById("itemBtn").disabled = false;
      document.getElementById("shopBtn").disabled = false;

      return;
    }

    /* --- ç›¸æ‰‹ãƒ©ã‚¦ãƒ³ãƒ‰ --- */
    if(data.type==="wait_turn"){
      myTurn = false;
      appendLog("systemBox","system-log", data.msg);

      // â˜… ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼šã‚¿ãƒ¼ãƒ³ +1
      turnCount++;
      updateRoundTurnUI();

// â˜… ç›¸æ‰‹ãƒ©ã‚¦ãƒ³ãƒ‰ã«ãªã£ãŸã‚‰ã‚·ãƒ§ãƒƒãƒ—ã‚’å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
      closeShopUI();

      document.getElementById("atkBtn").disabled = true;
      document.getElementById("skillBtn").disabled = true;
      document.getElementById("lvupBtn").disabled = true;
      document.getElementById("itemBtn").disabled = true;
      document.getElementById("shopBtn").disabled = true;


      return;
    }



    // ============================
    // â˜… å‹æ•—ç¢ºå®šï¼ˆæ¼”å‡ºç”¨ï¼‰
    // ============================
    if (data.type === "battle_end") {
      battleEnded = true;

      // â˜… å¯¾æˆ¦ä¸­BGMåœæ­¢
      stopBattleBgm();
      const backBtn = document.getElementById("btnBackToMenu");
      if (backBtn) backBtn.style.display = "inline-block";

      // æ—¢å­˜UIã‚’é–‰ã˜ã‚‹ï¼ˆå®‰å…¨ç­–ï¼‰
      closeShopUI();
      closeItemUI();

      showResultOverlay(data.result);
      return;
    }

    /* --- æˆ¦é—˜ãƒ­ã‚°ï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰ --- */
    if (data.type === "battle_log") {
      appendLog("battleBox", "battle-log", data.msg);

      // â˜… å‹æ•—ç¢ºå®šãƒ­ã‚°ã‚’æ¤œçŸ¥ï¼ˆserver.js ã®å®Ÿæ–‡è¨€ã«å®Œå…¨ä¸€è‡´ï¼‰
      if (
        data.msg.includes("ã®å‹åˆ©ï¼ï¼") ||
        data.msg.includes("å¼•ãåˆ†ã‘ï¼")
      ) {
        battleEnded = true;
        document.getElementById("btnBackToMenu").style.display = "inline-block";
      }

      return;
    }

    // ============================
    // â˜… ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡ºï¼ˆdamage_eventï¼‰
    // ============================
    if (data.type === "damage_event") {
      console.log("â˜… damage_event åˆ°é”", data);
      const sprites = getSprites();

      const targetSprite = sprites[data.target];

      // â˜… ã“ã“ã‚’è¿½åŠ 
      if (!targetSprite) {
        console.warn("damage_event: invalid target", data.target, sprites);
        return;
      }

      const attackerSprite =
        data.target === "self" || data.target === "self_doll"
          ? sprites.enemy
          : sprites.self;

      if (attackerSprite) attackerSprite.classList.add("attack");
      targetSprite.classList.add("hit");

      setTimeout(() => {
        if (attackerSprite) attackerSprite.classList.remove("attack");
        targetSprite.classList.remove("hit");
      }, 280);

      const offsetPx = bumpStack(data.target);
      const kind = data.kind ?? "normal";
      const amount = Number(data.amount ?? 0);

      spawnPopup(
        targetSprite,
        `damage-popup kind-${kind}`,
        amount ? `-${amount}` : "-",
        offsetPx
      );
      return;
    }


    // ============================
    // â˜… å›å¾©æ¼”å‡ºï¼ˆheal_eventï¼‰
    // ============================
    if (data.type === "heal_event") {
      const sprites = getSprites();
      const targetSprite = sprites[data.target];

      if (targetSprite) targetSprite.classList.add("heal");

      setTimeout(() => {
        if (targetSprite) targetSprite.classList.remove("heal");
      }, 480);

      const offsetPx = bumpStack(data.target);
      const amount = Number(data.amount ?? 0);

      spawnPopup(
        targetSprite,
        "heal-popup",
        amount ? `+${amount}` : "+",
        offsetPx
      );
      return;
    }


    if(data.type==="skill_log"){
      appendLog("battleBox","skill-log",data.msg);
      return;
    }

    /* --- ã‚·ã‚¹ãƒ†ãƒ  --- */
    if(data.type==="system_log"){
      appendLog("systemBox","system-log",data.msg);
      return;
    }

    /* --- ã‚¨ãƒ©ãƒ¼ --- */
    if(data.type==="error_log"){
      appendLog("systemBox","error-log",data.msg);
      return;
    }

    /* --- ãƒ‡ãƒãƒƒã‚° --- */
    if(data.type==="debug_log"){
      appendLog("debugBox","debug-log",data.msg);
      return;
    }

    /* --- level_up_request ã®è¿”ä¿¡ --- */
    if(data.type==="level_up_check"){
      if(data.canExp){
        ws.send(JSON.stringify({type:"level_up_exp"}));
        return;
      }
      if(data.canCoins){
        if(confirm(`EXPä¸è¶³ï¼\nã‚³ã‚¤ãƒ³${data.needCoins}ã§è£œå¡«ã—ã¾ã™ã‹ï¼Ÿ`)){
          ws.send(JSON.stringify({type:"level_up_coins"}));
        }
        return;
      }
      alert("âŒ EXPã‚‚ã‚³ã‚¤ãƒ³ã‚‚è¶³ã‚Šã¾ã›ã‚“ï¼");
    }

    // ---------- ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨çµæœ ----------
    if (data.type === "use_item_result") {
        if (data.success) {
            // æ­£å¸¸ä½¿ç”¨ â†’ ã‚¢ã‚¤ãƒ†ãƒ UIã‚’é–‰ã˜ã¦è¡Œå‹•ã«æˆ»ã‚‹
            closeItemUI();
        } else {
            // å¤±æ•— â†’ ã‚«ãƒ†ã‚´ãƒªé¸æŠã«æˆ»ã™
            document.getElementById("itemCategoryPopup").style.display = "flex";
            if (data.message) {
                alert(data.message);
            }
        }
        return;
    }

  };
}
/* ==================== æ¥ç¶šï¼ˆå¯¾äººæˆ¦ï¼‰ ==================== */
function join() {
  if (!selectedJobId) {
    alert("è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  myJob = selectedJobId; // â˜… ã“ã‚ŒãŒå¿…é ˆ

  ws = new WebSocket(WS_URL);
  attachWsHandlers();

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "join",
      account_id: window.accountId,
      name: window.accountName || "Player",
      job: myJob
    }));
  };
}





function join() {
  if (!selectedJobId) {
    alert("è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  myJob = selectedJobId; // â˜… ã“ã‚ŒãŒå¿…é ˆ

  ws = new WebSocket(WS_URL);
  attachWsHandlers();

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "join",
      account_id: window.accountId,
      name: window.accountName || "Player",
      job: myJob
    }));
  };
}





function joinRoom() {
  if (!selectedJobId) {
    alert("è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const roomCode = (document.getElementById("roomCodeInput")?.value ?? "").trim();
  if (!/^\d{4}$/.test(roomCode)) {
    alert("ãƒ«ãƒ¼ãƒ ç•ªå·ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  myJob = selectedJobId;

  ws = new WebSocket(WS_URL);
  attachWsHandlers();

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "join_room",
      room_code: roomCode,
      account_id: window.accountId,
      name: window.accountName || "Player",
      job: myJob
    }));
  };
}



function joinCpu() {
  if (ws) return;

  if (!selectedJobId) {
    alert("è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  myJob = selectedJobId;

  const cpuJobSelect = document.getElementById("cpuJob");
  const cpuJobValue = cpuJobSelect ? cpuJobSelect.value : null;

  ws = new WebSocket(WS_URL);
  attachWsHandlers();

  ws.onopen = () => {
    const turnOrder =
      document.getElementById("cpuTurnOrder")?.value ?? "random";

    ws.send(JSON.stringify({
      type: "join_cpu",
      cpu_kind: window.cpuKind || "menu",
      account_id: window.accountId,
      name: window.accountName || "Player",
      job: myJob,
      cpu_job: cpuJobValue || null,
      turn_order: turnOrder
    }));
  };
}



function rerollShop() {
    ws.send(JSON.stringify({ type: "shop_reroll" }));
}

/* ================= è¡Œå‹• ================= */
function attack(){
  if(!myTurn) return;
  ws.send(JSON.stringify({type:"action", action:"æ”»æ’ƒ"}));
}

/* ================= ã‚¹ã‚­ãƒ«ç³» ================= */
function openSkillUI(){
  const list = document.getElementById("skillList");
  list.innerHTML = "";

  const jobId = myJob;


  if (!SKILLS[jobId]) {
    console.error("ã‚¹ã‚­ãƒ«å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", myJob, jobId);
    return;
  }


  SKILLS[jobId].forEach((s, i) => {
    const needLv = i + 1;

    const row = document.createElement("div");
    row.className = "skillRow";

    const isDoll = (myJob === "äººå½¢ä½¿ã„" || myJob === 9);
    const isDollSkill1 = isDoll && i === 0;
    const isDollSkill2 = isDoll && i === 1;
    const isDollSkill3 = isDoll && i === 2;

    // â† ã“ã“ãŒå·®ã—æ›¿ãˆéƒ¨åˆ†
    const nameDiv = document.createElement("div");
    nameDiv.className = "skillName";
    nameDiv.textContent = `ã€${i+1}ã€‘${s.name}`;

    const descDiv = document.createElement("div");
    descDiv.className = "skillDesc";
    descDiv.textContent = s.desc;

    const btn = document.createElement("button");
    const remain = Number(window.skillRemaining?.[i + 1] ?? 1);

    // â˜… ä½¿ç”¨å›æ•°ãŒ0ã§ã‚‚ã€ŒæŠ¼ã—ãŸã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€ã‚’å‡ºã™ï¼ˆè¦ä»¶ï¼‰
    if (remain <= 0) {
      btn.textContent = "ä½¿ç”¨";
      btn.classList.add("used-up");
      btn.addEventListener("click", () => {
        showCenterToast("ã‚¹ã‚­ãƒ«ã®ä½¿ç”¨å›æ•°ãŒãªããªã‚Šã¾ã—ãŸ", 2500);
      });
    } else {
      btn.textContent = "ä½¿ç”¨";
    }

    // â˜… ãƒ¬ãƒ™ãƒ«æœªè§£æ”¾ã¯å„ªå…ˆçš„ã«æŠ¼ã›ãªã„ï¼ˆè¡¨ç¤ºæ–‡è¨€ã¯ãã®ã¾ã¾ï¼‰
    if (myLevel < needLv) btn.disabled = true;

    // â˜… ä½¿ç”¨å›æ•°ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã®ã¿ã€å®Ÿéš›ã®ç™ºå‹•å‡¦ç†ã‚’ç´ä»˜ã‘ã‚‹
    if (remain > 0) {
      if (isDollSkill1) {
        btn.addEventListener("click", useDollSkill1);
      } else if (isDollSkill2) {
        btn.addEventListener("click", useDollSkill2Prompt);
      } else if (isDollSkill3) {
        btn.addEventListener("click", useDollSkill3);
      } else {
        btn.addEventListener("click", () => useSkill(i + 1));
      }
    }

    row.appendChild(nameDiv);
    row.appendChild(descDiv);
    row.appendChild(btn);

    list.appendChild(row);
  });

  document.getElementById("skillPopup").style.display = "flex";
}




function closeSkillUI(){
  document.getElementById("skillPopup").style.display="none";
}

function useSkill(num){
  if(!myTurn) return;

  // â˜… å¼“å…µã‚¹ã‚­ãƒ«2ï¼šarrowSlots ã‚’å…ˆã«åæ˜ ï¼ˆè¡¨ç¤ºç”¨ï¼‰
  if (window.myJob === "å¼“å…µ" && num === 2) {
    window.arrowSlots = 2;
  }

  ws.send(JSON.stringify({type:"action", action:"ã‚¹ã‚­ãƒ«"+num}));
  closeSkillUI();
}

// ================================
// äººå½¢ä½¿ã„ï¼šã‚¹ã‚­ãƒ«1å°‚ç”¨å…¥å£
// ================================
function useDollSkill1(){
  if(!myTurn) return;

  ws.send(JSON.stringify({
    type: "request_doll_skill1"
  }));

}

// ================================
// äººå½¢ä½¿ã„ï¼šã‚¹ã‚­ãƒ«2ï¼ˆç”Ÿå‘½ç¸«åˆï¼‰HPâ†’è€ä¹…
// ================================
function useDollSkill2Prompt(){
  if(!myTurn) return;

  const s = prompt("æ¶ˆè²»ã™ã‚‹HPã‚’å…¥åŠ›ï¼ˆ10ã®å€æ•° / 10ã€œ100ï¼‰", "10");
  if (s === null) return;

  const hpCost = Number(s);

  ws.send(JSON.stringify({
    type: "use_doll_skill2",
    hpCost
  }));

  console.log("[client] use_doll_skill2 sent:", hpCost);
  closeSkillUI();
}
// ================================
// äººå½¢ä½¿ã„ï¼šã‚¹ã‚­ãƒ«3ï¼ˆæš´èµ°ï¼‰
// ================================
function useDollSkill3(){
  if(!myTurn) return;

  ws.send(JSON.stringify({
    type: "request_doll_skill3"
  }));

  console.log("[client] request_doll_skill3 sent");
  closeSkillUI();
}

/* ================= ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— ================= */
function tryLevelUp(){
  ws.send(JSON.stringify({ type:"level_up_request" }));
}

function openItemUI(){
  document.getElementById("itemCategoryPopup").style.display = "flex";
}


function useItem(id, action, slot = 1){
  console.log("[CLIENT] useItem called", id, action, slot);

  ws.send(JSON.stringify({
    type: "use_item",
    item_id: id,
    action: action,
    slot: slot
  }));

}


function closeItemCategory(){
  document.getElementById("itemCategoryPopup").style.display = "none";
}



function openItemCategory(category){
  currentItemCategory = category;
  isItemUIOpen = true; // â˜… é–‹ã„ãŸ

  const all = window.itemList || [];
  const list = all.filter(it => it.category === category);

  const titleMap = {
    item: "ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§",
    equip: "è£…å‚™ä¸€è¦§",
    special: "ç‰¹æ®Šè£…å‚™ä¸€è¦§"
  };
  document.getElementById("itemPopupTitle").innerText = titleMap[category];

  const box = document.getElementById("itemList");
  box.innerHTML = "";

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "skillRow";

    let btn = "";

    // â˜… ä½¿ç”¨ã§ãã‚‹ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆå›å¾©ãƒ»ä¿®ç†ã‚­ãƒƒãƒˆãªã©ï¼‰
    if (
      category === "item" ||
      (category === "special" && it.name === "ä¿®ç†ã‚­ãƒƒãƒˆ")
    ) {
      btn = `<button onclick="useItem('${it.uid}','use')">ä½¿ç”¨</button>`;
    }
    // â˜… è£…å‚™ç³»
    else {
      btn = `<button onclick="onEquipButtonByUid('${it.uid}')">è£…å‚™</button>`;
    }


    row.innerHTML = `
      <div class="skillName">${it.name}</div>
      <div style="font-size:12px; color:#ccc; white-space:pre-line;">
        ${it.effect_text ?? ""}
      </div>
      <div style="margin-top:5px;">${btn}</div>
    `;

    box.appendChild(row);
  });

  document.getElementById("itemPopup").style.display = "flex";
}

function closeItemUI(){
  document.getElementById("itemPopup").style.display = "none";
  isItemUIOpen = false;        // â˜… é–‰ã˜ãŸ
  currentItemCategory = null; // â˜… ãƒªã‚»ãƒƒãƒˆ
}



// ========================
// â˜… ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½è¿½åŠ 
// ========================

function openShop(){
  if (!myTurn) return;
  ws.send(JSON.stringify({ type: "open_shop" }));
}

function closeShopUI(){
  document.getElementById("shopPopup").style.display = "none";
}

function renderShop(items){
  const box = document.getElementById("shopList");
  box.innerHTML = "";

  items.forEach((it, idx) => {
    if (!it) return;

    const desc = it.effect_text ?? "";

    box.innerHTML += `
      <div class="skillRow">
        <div>
          <div>${it.name}</div>
          <div>ä¾¡æ ¼: ${it.price} / ${desc}</div>
        </div>
        <div><button onclick="buyItem(${idx})">è³¼å…¥</button></div>
      </div>
    `;
  });

  document.getElementById("shopPopup").style.display = "flex";
}

function openStatusDetail(target) {
  ws.send(JSON.stringify({
    type: "request_status_detail",
    target  // "self" or "enemy"
  }));
}

function closeStatusDetail() {
  document.getElementById("statusDetailPopup").style.display = "none";
}

function openArrowSlotSelect(item) {
  pendingArrowItem = item;

  // slot2 ãŒä½¿ãˆã‚‹ã‹ã¯ã€Œæœ€å¾Œã«å—ä¿¡ã—ãŸå€¤ã€ã§åˆ¤æ–­
  if (window.arrowSlots >= 2) {
    const slot = confirm(
      "ã©ã¡ã‚‰ã®ã‚¹ãƒ­ãƒƒãƒˆã«è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ\nOK: ã‚¹ãƒ­ãƒƒãƒˆ2 / ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ã‚¹ãƒ­ãƒƒãƒˆ1"
    )
      ? 2
      : 1;

    useItem(item.uid, "arrow", slot);
  } else {
    useItem(item.uid, "arrow", 1);
  }

  pendingArrowItem = null;
}
function onEquipButton(item) {
 

  // ===== çŸ¢åˆ¤å®šï¼ˆåå‰ or è£…å‚™ç¨®åˆ¥ã§åˆ¤æ–­ï¼‰=====
  const isArrow =
    item.equip_type?.includes("arrow") ||
    item.name?.includes("çŸ¢");

  if (isArrow) {

    // slot2 ãŒä½¿ãˆã‚‹ãªã‚‰é¸ã°ã›ã‚‹
    if (window.arrowSlots >= 2) {
      const slot = confirm(
        "ã‚¹ãƒ­ãƒƒãƒˆ2ã«è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ\nOK: ã‚¹ãƒ­ãƒƒãƒˆ2 / ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ã‚¹ãƒ­ãƒƒãƒˆ1"
      )
        ? 2
        : 1;

      useItem(item.uid, "arrow", slot);
    } else {
      useItem(item.uid, "arrow", 1);
    }
    return; // â˜… ã“ã“ã§å¿…ãšçµ‚äº†
  }

  // â˜… äººå½¢è¡£è£…ã¯ special æ‰±ã„
  if (item.is_doll_costume) {
    useItem(item.uid, "special");
    return;
  }

  // ä»¥ä¸‹ã¯ä»Šã¾ã§é€šã‚Š
  if (
    item.equip_type === "mage_equip" ||
    item.equip_type === "alchemist_unique"
  ) {
    useItem(item.uid, "special");
  } else {
    useItem(item.uid, "equip");
  }
}



function onEquipButtonByUid(uid) {
  console.log("[DEBUG] onEquipButtonByUid uid =", uid);
  console.log("[DEBUG] itemList =", window.itemList);

  const item = (window.itemList || []).find(it => it.uid === uid);
  if (!item) {
    console.error("item not found:", uid);
    return;
  }
  onEquipButton(item);
}


function selectDollPart(part){
  console.log("[client] selectDollPart:", part);

  ws.send(JSON.stringify({
    type: "use_doll_skill1",
    part
  }));

  closeSkillUI();   // â˜… æ—¢å­˜ã®é–¢æ•°ã«åˆã‚ã›ã‚‹
}


function buyItem(index){
  if (!myTurn) return;
  ws.send(JSON.stringify({ type:"buy_item", index }));
  // â˜… è³¼å…¥ã—ã¦ã‚‚ã‚·ãƒ§ãƒƒãƒ—ã¯é–‰ã˜ãªã„ï¼ˆé€£ç¶šè³¼å…¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
}
// ================================
// â˜… renderItemListï¼ˆä¸­èº«ã¯ç©ºã§OKï¼‰
// ================================
function renderItemList(items) {
  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸ item_list ã¯
  // window.itemList ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
  // ç”»é¢è¡¨ç¤ºã¯ openItemCategory() ã®ã¨ãã«è¡Œã‚ã‚Œã‚‹ã€‚
  // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªãã¦ã‚ˆã„ã€‚
}

function toggleEnemyDetail() {
  const el = document.getElementById("enemy-detail");
  el.style.display = (el.style.display === "none") ? "block" : "none";
}


// ============================
// â˜… ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼šPC=hover / ã‚¹ãƒãƒ›=tap ã§è¡¨ç¤º
//   - è£…å‚™æ  / ç‰¹æ®Šè£…å‚™æ  / ãƒãƒ•æ 
//   - ç”»é¢ã®åˆ¥ã®å ´æ‰€ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
// ============================
function closeAllTooltips(exceptEl = null) {
  document.querySelectorAll('.tooltip-open').forEach(el => {
    if (exceptEl && (el === exceptEl || el.contains(exceptEl) || exceptEl.contains(el))) return;
    el.classList.remove('tooltip-open');
  });
}

function setupTapTooltips() {
  document.addEventListener('pointerdown', (e) => {
    const t = e.target;
    const slot = t.closest('.equip-slot, .special-equip-slot, .buff-slot');

    // ã©ã®æ ã§ã‚‚ãªã„ â†’ å…¨éƒ¨é–‰ã˜ã‚‹
    if (!slot) {
      closeAllTooltips();
      return;
    }

    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãŒç„¡ã„æ ã¯ç„¡è¦–ï¼ˆç©ºæ ãªã©ï¼‰
    const hasTooltip = slot.querySelector('.equip-tooltip, .buff-tooltip');
    if (!hasTooltip) return;

    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è‡ªä½“ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã¯é–‰ã˜ãªã„
    if (slot.classList.contains('tooltip-open') && t.closest('.equip-tooltip, .buff-tooltip')) {
      e.stopPropagation();
      return;
    }

    const willOpen = !slot.classList.contains('tooltip-open');
    closeAllTooltips(slot);

    if (willOpen) slot.classList.add('tooltip-open');
    else slot.classList.remove('tooltip-open');

    // ç›´å¾Œã® click ã§é–‰ã˜ãªã„ã‚ˆã†ã«
    e.stopPropagation();
  }, true);

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒªã‚µã‚¤ã‚ºæ™‚ã‚‚é–‰ã˜ã‚‹ï¼ˆç”»é¢å¤–ã«æ®‹ã‚‹ã®ã‚’é˜²ãï¼‰
  window.addEventListener('scroll', () => closeAllTooltips(), true);
  window.addEventListener('resize', () => closeAllTooltips(), true);
}

setupTapTooltips();

setPhase(PHASE.MODE_SELECT);

document.getElementById("btnRandom").onclick = () => {
  setPhase(PHASE.RANDOM_READY);

  document.getElementById("phase1Title").textContent = "ãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦";

  window.isCpuMode = false;
  window.matchMode = "random";

  const roomArea = document.getElementById("roomCodeArea");
  if (roomArea) roomArea.style.display = "none";

  // CPUè·æ¥­é¸æŠã‚’éš ã™
  document.getElementById("cpuJobArea").style.display = "none";

  const status = document.getElementById("connectStatus");
  if (status) status.textContent = "";
};


document.getElementById("btnRoom").onclick = () => {
  setPhase(PHASE.RANDOM_READY);

  document.getElementById("phase1Title").textContent = "ãƒ«ãƒ¼ãƒ å¯¾æˆ¦";

  window.isCpuMode = false;
  window.matchMode = "room";

  const roomArea = document.getElementById("roomCodeArea");
  if (roomArea) roomArea.style.display = "block";

  // CPUè·æ¥­é¸æŠã‚’éš ã™
  document.getElementById("cpuJobArea").style.display = "none";

  const status = document.getElementById("connectStatus");
  if (status) status.textContent = "ãƒ«ãƒ¼ãƒ ç•ªå·ã‚’å…¥åŠ›ã—ã€è·æ¥­ã‚’é¸ã‚“ã§æ¥ç¶šã—ã¦ãã ã•ã„";
};



document.getElementById("btnConnectPhase1").onclick = () => {
  if (isConnecting) return; // â˜… äºŒé‡æŠ¼ã—é˜²æ­¢

  // â˜… è·æ¥­æœªé¸æŠãªã‚‰æ¥ç¶šä¸å¯
  if (!selectedJobId) {
    alert("è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  if (window.matchMode === "room") {
    const roomCode = (document.getElementById("roomCodeInput")?.value ?? "").trim();
    if (!/^\d{4}$/.test(roomCode)) {
      alert("ãƒ«ãƒ¼ãƒ ç•ªå·ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
  }

  isConnecting = true;
  document.getElementById("btnConnectPhase1").disabled = true;

  clearCpuFailTimer();

  if (window.matchMode === "cpu") {
    document.getElementById("connectStatus").textContent = "CPUã¨æ¥ç¶šä¸­...";
    joinCpu();
    return;
  }

  // random / room
  startMatchTimer();

  if (window.matchMode === "room") {
    joinRoom();
  } else {
    // random
    join();
  }
};


document.getElementById("btnCancelRandom").onclick = () => {
  cleanupSocket();

  stopMatchTimer();
  clearCpuFailTimer();

  isConnecting = false;
  document.getElementById("btnConnectPhase1").disabled = false;
  document.getElementById("connectStatus").textContent = "";

  setPhase(PHASE.MODE_SELECT);
  refreshSummary();
  fetchAndRenderRanking(currentRankingJob);
};

document.getElementById("btnCPU").onclick = () => {
  setPhase(PHASE.RANDOM_READY);

  document.getElementById("phase1Title").textContent = "CPUæˆ¦";

  window.isCpuMode = true;
  window.matchMode = "cpu";
  window.cpuKind = "menu";

  const roomArea = document.getElementById("roomCodeArea");
  if (roomArea) roomArea.style.display = "none";

  // CPUè·æ¥­é¸æŠã‚’è¡¨ç¤º
  document.getElementById("cpuJobArea").style.display = "block";

  document.getElementById("connectStatus").textContent =
    "CPUã¨å¯¾æˆ¦ã—ã¾ã™ï¼ˆè·æ¥­ã‚’é¸ã‚“ã§æ¥ç¶šã—ã¦ãã ã•ã„ï¼‰";
};




document.getElementById("btnBackToMenu").onclick = () => {
  // é€šä¿¡ã‚’å®Œå…¨ã«åˆ‡ã‚‹
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  }

  ws = null;

  // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  myTurn = false;
  myLevel = 1;
  battleEnded = false;
  window.itemList = [];
  window.arrowSlots = 1;

  document.getElementById("cpuJobArea").style.display = "none";

  // ãƒœã‚¿ãƒ³ã‚’å†ã³éš ã™
  document.getElementById("btnBackToMenu").style.display = "none";

  // ãƒ­ã‚°ã‚¯ãƒªã‚¢ï¼ˆä»»æ„ï¼‰
  document.getElementById("battleBox").innerHTML = "";
  document.getElementById("systemBox").innerHTML = "";
  document.getElementById("debugBox").innerHTML = "";

  // ã‚¿ã‚¤ãƒˆãƒ«ã¸
  

setPhase(PHASE.MODE_SELECT);
  refreshSummary();
  fetchAndRenderRanking(currentRankingJob);
  window.isCpuMode = false;

};



/* ==== INITIALIZE ACCOUNT + TITLE RANKING ==== */
(async () => {
  await ensureAccount();
  await refreshSummary();
  renderRankingButtons();
  setAccountNameUI();

  const btn = document.getElementById("btnChangeName");
  if (btn) btn.onclick = changeNameFlow;

  await fetchAndRenderRanking("æˆ¦å£«");
})();

</script>
</div>
</div></body>
</html>
